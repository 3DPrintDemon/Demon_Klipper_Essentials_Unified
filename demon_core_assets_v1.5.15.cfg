
###################################################
#######>>>>>>>>>>  3DPrintDemon  <<<<<<<<<<<#######
#######   https://github.com/3DPrintDemon   #######


[gcode_macro _CORE_VARS]

variable_orca_bed_offset: 0.00
variable_offset_reset: False
variable_orca_surface: "High Temp Plate"
variable_filament: "PLA"
variable_layer: 0.2
variable_noz: 0
variable_bed: 0
variable_chamber_thermal_sensor: 0
variable_heat_wait_temp: 10
variable_fan_speed: 0
variable_nm_fan_speed: 0
variable_last_known_z: 0
variable_z_park: 30
variable_fil_change_pause: False
variable_no_home_z_move: False
variable_prompt_running: False
variable_heat_soaked: False
variable_bed_state: 0.00
variable_prev_probe_query: 0.00
variable_tolerance_chain: 1
variable_limit_counter: 0
variable_stage_one_end: False
variable_gcode_started: False
variable_slicer_gcode: ""

gcode:

#######################################################
# DEMON PRINT START ASSETS
#######################################################

[gcode_macro PRINT_START_HEATSOAK_TIMERS]
description: Choose the temps for your PRINT START heatsoak. Any changes not visable in saved file, only in active RAM. Use the readback macro to see current settings!
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set lotimer = params.LOW_TEMP_TIMER|default(0)|int %}
  {% set hitimer = params.HI_TEMP_TIMER|default(0)|int %}
  {% set detimer = params.DEFAULT_TEMP_TIMER|default(0)|int %}

  {% if 'LOW_TEMP_TIMER' not in params and 'HI_TEMP_TIMER' not in params and 'DEFAULT_TEMP_TIMER' not in params %}
    RESPOND TYPE=error MSG="Please enter a value to change the setting!"
    
  {% else %}
    {% if 'LOW_TEMP_TIMER' in params %}
      {% if lotimer <= 0 %}
        RESPOND TYPE=COMMAND MSG="Print start heatsoak timer cannot be 0, value of 1 or higher can be accepted. Timer set for 1 minute."
        SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=lo_temp_timer VALUE=1
    
      {% elif lotimer >= 1 %}
        RESPOND TYPE=COMMAND MSG="Print start heatsoak. Low temp timer set to {lotimer|int} minutes"
        SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=lo_temp_timer VALUE={lotimer|int}
      {% endif %}

    {% else %}  
    {% endif %}

    {% if 'HI_TEMP_TIMER' in params %}
      {% if hitimer <= 0 %}
        RESPOND TYPE=COMMAND MSG="Print start heatsoak timer cannot be 0, value of 1 or higher can be accepted. Timer set for 1 minute."
        SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=hi_temp_timer VALUE=1
    
      {% elif hitimer >= 1 %}
        RESPOND TYPE=COMMAND MSG="Print start heatsoak. High temp timer set to {hitimer|int} minutes"
        SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=hi_temp_timer VALUE={hitimer|int}
      {% endif %}

    {% else %}  
    {% endif %}

  {% if 'DEFAULT_TEMP_TIMER' in params %}
      {% if detimer <= 0 %}
        RESPOND TYPE=COMMAND MSG="Print start heatsoak timer cannot be 0, value of 1 or higher can be accepted. Timer set for 1 minute."
        SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=default_temp_timer VALUE=1
    
      {% elif hitimer >= 1 %}
        RESPOND TYPE=COMMAND MSG="Print start heatsoak. Default temp timer for unassigned profiles set to {detimer|int} minutes"
        SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=default_temp_timer VALUE={detimer|int}
      {% endif %}

    {% else %}  
    {% endif %}
    
  {% endif %}



[gcode_macro NEVERMORE_TOGGLE]
description: Toggle the use of your NEVERMORE fan on & off with each click of this button! State must be set BEFORE you start a print! If you dont have a fan you will get errors on use!
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  
  {% if start_vars.nevermore == False %}
    RESPOND TYPE=error MSG="NEVERMORE FAN ENABLED!"
    SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=nevermore VALUE=True

  {% elif start_vars.nevermore == True %}
    RESPOND TYPE=error MSG="NEVERMORE FAN DISABLED!"
    SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=nevermore VALUE=False
  {% endif %}
  


[gcode_macro ADAPTIVE_MESHING_TOGGLE]
description: Toggle the use of adaptive besh meshing on & off with each click of this button! State must be set BEFORE you start a print! Must have bed meshes built & stored!
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  
  {% if start_vars.adaptive_meshing == False %}
    RESPOND TYPE=error MSG="ADAPTIVE MESHING IS ON!"
    SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=adaptive_meshing VALUE=True

  {% elif start_vars.adaptive_meshing == True %}
    RESPOND TYPE=error MSG="ADAPTIVE MESHING IS OFF!"
    SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=adaptive_meshing VALUE=False
  {% endif %}


[gcode_macro PURGE_LINE_TOGGLE]
description: Toggle the printing of all PRINT_START purge lines on & off with each click of this button! State must be set BEFORE you start a print!
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  
  {% if start_vars.purge_lines == False %}
    RESPOND TYPE=error MSG="PURGE LINE PRINTING IS ON!"
    SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=purge_lines VALUE=True

  {% elif start_vars.purge_lines == True %}
    RESPOND TYPE=error MSG="PURGE LINE PRINTING IS OFF!"
    SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=purge_lines VALUE=False
  {% endif %}

  
  
[gcode_macro PRINT_START_QUICK_SETTINGS_READBACK]
description: Use this macro to see your live Quick Settings! Any changes to these Quick Settings are not visible in the saved macro files. Only in active RAM.
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}

    RESPOND TYPE=COMMAND MSG="Nevermore Enabled: {start_vars.nevermore}"
    RESPOND TYPE=COMMAND MSG="Default temperature heatsoak timer for unassigned profiles is set to {start_vars.default_temp_timer} minutes"
    RESPOND TYPE=COMMAND MSG="Low temperature heatsoak timer is set to {start_vars.lo_temp_timer} minutes"
    RESPOND TYPE=COMMAND MSG="High temperature heatsoak timer is set to {start_vars.hi_temp_timer} minutes"
    RESPOND TYPE=COMMAND MSG="Adaptive meshing is active: {start_vars.adaptive_meshing}" 
    RESPOND TYPE=COMMAND MSG="Draw PRINT_START purge line is active: {start_vars.purge_lines}" 
    RESPOND TYPE=COMMAND MSG="Heatsoak timer is to be skipped: {start_vars.start_my_print_already}"
   
    

[gcode_macro _INITIAL_SETUP]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}
   
  {% if start_vars.use_slicer_feed_rate != True %}
    M220 S{start_vars.feed_rate}
  {% endif %}
 
  {% if core_vars.filament in ['PLA', 'PLA+'] and core_vars.layer|float <0.25%}
    {% if start_vars.use_slicer_flow != True %}
      M221 S{start_vars.pla_flow_rate}
    {% endif %}
    
    {% if start_vars.use_slicer_pa_values != True %}
      SET_PRESSURE_ADVANCE ADVANCE={start_vars.pla_pa} SMOOTH_TIME={start_vars.pla_st}
    {% endif %}

  {% elif core_vars.filament == 'ASA' and core_vars.layer|float <0.25%}
    {% if start_vars.use_slicer_flow != True %}
      M221 S{start_vars.asa_flow_rate}
    {% endif %}

    {% if start_vars.use_slicer_pa_values != True %}
      SET_PRESSURE_ADVANCE ADVANCE={start_vars.asa_pa} SMOOTH_TIME={start_vars.asa_st}
    {% endif %}

  {% elif core_vars.filament == 'ABS' and core_vars.layer|float <0.25%}
    {% if start_vars.use_slicer_flow != True %}
      M221 S{start_vars.abs_flow_rate}
    {% endif %}

    {% if start_vars.use_slicer_pa_values != True %}
      SET_PRESSURE_ADVANCE ADVANCE={start_vars.abs_pa} SMOOTH_TIME={start_vars.abs_st}
    {% endif %}

  {% elif core_vars.filament in ['PET', 'PETG'] and core_vars.layer|float <0.25%}
    {% if start_vars.use_slicer_flow != True %}
      M221 S{start_vars.petg_flow_rate}
    {% endif %}
    
    {% if start_vars.use_slicer_pa_values != True %}
      SET_PRESSURE_ADVANCE ADVANCE={start_vars.petg_pa} SMOOTH_TIME={start_vars.petg_st}
    {% endif %}

  {% elif core_vars.filament in ['FLEX', 'TPU'] and core_vars.layer|float <0.25%}
    {% if start_vars.use_slicer_flow != True %}
      M221 S{start_vars.tpu_flow_rate}
    {% endif %}
    
    {% if start_vars.use_slicer_pa_values != True %}
      SET_PRESSURE_ADVANCE ADVANCE={start_vars.tpu_pa} SMOOTH_TIME={start_vars.tpu_st}
    {% endif %}

  {% elif core_vars.filament in ['PLA', 'PLA+'] and core_vars.layer|float >0.26%}
    {% if start_vars.use_slicer_flow != True %}
      M221 S{start_vars.pla_hi_flow_rate}
    {% endif %}
    
    {% if start_vars.use_slicer_pa_values != True %}
      SET_PRESSURE_ADVANCE ADVANCE={start_vars.pla_pa} SMOOTH_TIME={start_vars.pla_st}
    {% endif %}

  {% elif core_vars.filament == 'ASA' and core_vars.layer|float >0.26%}
    {% if start_vars.use_slicer_flow != True %}
      M221 S{start_vars.asa_hi_flow_rate}
    {% endif %}

    {% if start_vars.use_slicer_pa_values != True %}
      SET_PRESSURE_ADVANCE ADVANCE={start_vars.asa_pa} SMOOTH_TIME={start_vars.asa_st}
    {% endif %}

  {% elif core_vars.filament == 'ABS' and core_vars.layer|float >0.26%}
    {% if start_vars.use_slicer_flow != True %}
      M221 S{start_vars.abs_hi_flow_rate}
    {% endif %}

    {% if start_vars.use_slicer_pa_values != True %}
      SET_PRESSURE_ADVANCE ADVANCE={start_vars.abs_pa} SMOOTH_TIME={start_vars.abs_st}
    {% endif %}

  {% elif core_vars.filament in ['PET', 'PETG'] and core_vars.layer|float >0.26%}
    {% if start_vars.use_slicer_flow != True %}
      M221 S{start_vars.petg_hi_flow_rate}
    {% endif %}

    {% if start_vars.use_slicer_pa_values != True %}
      SET_PRESSURE_ADVANCE ADVANCE={start_vars.petg_pa} SMOOTH_TIME={start_vars.petg_st}
    {% endif %}
   
  {% elif core_vars.filament in ['FLEX', 'TPU'] and core_vars.layer|float >0.26%}
    {% if start_vars.use_slicer_flow != True %}
      M221 S{start_vars.tpu_hi_flow_rate}
    {% endif %}

    {% if start_vars.use_slicer_pa_values != True %}
      SET_PRESSURE_ADVANCE ADVANCE={start_vars.tpu_pa} SMOOTH_TIME={start_vars.tpu_st}
    {% endif %}
  {% endif %}



[gcode_macro _NOZZLE_PREHEAT_CONTROL]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}

  {% if 'probe_eddy_ng btt_eddy' in printer or 'probe_eddy_ng eddy' in printer %}
    {% if start_vars.eddy_ng_tap_temperature|int < 90 %}
      RESPOND TYPE=error MSG="Warning Eddy NG tap temerature is too low, resetting to 150c!"
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET=150 
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM=148 MAXIMUM=155
    {% elif start_vars.eddy_ng_tap_temperature|int > 200 %}
      RESPOND TYPE=error MSG="Warning Eddy NG tap temerature is too high, resetting to 150c!"
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET=150 
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM=148 MAXIMUM=155

    {% elif start_vars.eddy_ng_tap_temperature|int >= 90 and start_vars.eddy_ng_tap_temperature|int <= 200 %}
      SET_DISPLAY_TEXT MSG="Hotend Preheat: TAP OVERRIDE TEMP {start_vars.eddy_ng_tap_temperature|int}c"
      RESPOND TYPE=COMMAND MSG="Hotend Preheat: TAP OVERRIDE TEMP {start_vars.eddy_ng_tap_temperature|int}c"
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.eddy_ng_tap_temperature|int} 
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.eddy_ng_tap_temperature|int -2} MAXIMUM={start_vars.eddy_ng_tap_temperature|int + 5}
    {% endif %}
    
  {% else %}
    {% if core_vars.filament in ['PLA', 'PLA+'] %} 
      SET_DISPLAY_TEXT MSG="PLA File Detected Hotend Preheat: {start_vars.pla_noz_pre|int}c"          # Displays info 
      RESPOND TYPE=COMMAND MSG="PLA File Detected Hotend Preheat: {start_vars.pla_noz_pre|int}c"          # Displays info 
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.pla_noz_pre|int} 
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.pla_noz_pre|int -2} MAXIMUM={start_vars.pla_noz_pre|int + 5}
  
    {% elif core_vars.filament == 'ASA' %} 
      SET_DISPLAY_TEXT MSG="ASA File Detected Hotend Preheat: {start_vars.asa_noz_pre|int}c"          # Displays info 
      RESPOND TYPE=COMMAND MSG="ASA File Detected Hotend Preheat: {start_vars.asa_noz_pre|int}c"          # Displays info 
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.asa_noz_pre|int} 
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.asa_noz_pre|int -2} MAXIMUM={start_vars.asa_noz_pre|int + 5}    
  
    {% elif core_vars.filament == 'ABS' %} 
      SET_DISPLAY_TEXT MSG="ABS File Detected Hotend Preheat: {start_vars.abs_noz_pre|int}c"          # Displays info 
      RESPOND TYPE=COMMAND MSG="ABS File Detected Hotend Preheat: {start_vars.abs_noz_pre|int}c"          # Displays info 
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.abs_noz_pre|int} 
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.abs_noz_pre|int -2} MAXIMUM={start_vars.abs_noz_pre|int + 5}    

    {% elif core_vars.filament in ['PET', 'PETG'] %}
      SET_DISPLAY_TEXT MSG="PETG File Detected Hotend Preheat: {start_vars.petg_noz_pre|int}c"          # Displays info 
      RESPOND TYPE=COMMAND MSG="PETG File Detected Hotend Preheat: {start_vars.petg_noz_pre|int}c"          # Displays info 
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.petg_noz_pre|int} 
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.petg_noz_pre|int -2} MAXIMUM={start_vars.petg_noz_pre|int + 5}

    {% elif core_vars.filament in ['FLEX', 'TPU'] %}
      SET_DISPLAY_TEXT MSG="TPU File Detected Hotend Preheat: {start_vars.tpu_noz_pre|int}c"          # Displays info 
      RESPOND TYPE=COMMAND MSG="TPU File Detected Hotend Preheat: {start_vars.tpu_noz_pre|int}c"          # Displays info 
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.tpu_noz_pre|int} 
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.tpu_noz_pre|int -2} MAXIMUM={start_vars.tpu_noz_pre|int + 5}

    {% elif core_vars.filament not in ['PLA', 'PLA+', 'ASA', 'ABS', 'PET', 'PETG', 'FLEX', 'TPU'] %}
      {% if core_vars.noz|int < 230 %}
        SET_DISPLAY_TEXT MSG="Hotend Preheat by file temp: {start_vars.default_lo_noz_pre|int}c"          # Displays info        
        RESPOND TYPE=COMMAND MSG="Hotend Preheat by file temp: {start_vars.default_lo_noz_pre|int}c"          # Displays info        
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.default_lo_noz_pre|int} 
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.default_lo_noz_pre|int -2} MAXIMUM={start_vars.default_lo_noz_pre|int + 5}

      {% else %}
        SET_DISPLAY_TEXT MSG="Hotend Preheat by file temp: {start_vars.default_hi_noz_pre|int}c"          # Displays info          
        RESPOND TYPE=COMMAND MSG="Hotend Preheat by file temp: {start_vars.default_hi_noz_pre|int}c"          # Displays info      
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.default_hi_noz_pre|int} 
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.default_hi_noz_pre|int -2} MAXIMUM={start_vars.default_hi_noz_pre|int + 5}
      {% endif %}  
    {% endif %}
  {% endif %}



[gcode_macro _CHAMBER_SENSOR_DEFINE]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}
 
  {% if start_vars.chamber_fan and start_vars.chamber_sensor == True %}
    {action_raise_error("This error is caused by multiple chamber thermal sensors being set for use in the demon_user_settings file, please disable one sensor & restart the print!")} 

  {% elif ('temperature_sensor Chamber_Temp' not in printer.configfile.config) and ('temperature_fan chamber' not in printer.configfile.config) %}
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=chamber_thermal_sensor VALUE=3 
    
  {% elif ('temperature_fan chamber' in printer.configfile.config) %}
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=chamber_thermal_sensor VALUE=1

  {% elif ('temperature_sensor Chamber_Temp' in printer.configfile.config) %}
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=chamber_thermal_sensor VALUE=2
  
  {% endif %}



[gcode_macro _BED_FANS_SETUP]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}

  {% if core_vars.filament in ['PLA', 'PLA+'] %} 
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_threshold VALUE={start_vars.pla_min_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={start_vars.pla_max_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={start_vars.pla_bed_fan_low_speed}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={start_vars.pla_bed_fan_high_speed}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool VALUE={start_vars.pla_bed_fan_cool}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool_temp VALUE={start_vars.post_print_cool}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE={start_vars.pla_bed_fan_enable}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan_enable VALUE={start_vars.chamber_fan}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_monitor VALUE={start_vars.floating_bed_fans}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={start_vars.floating_bed_fans_max}
      M400

    {% elif core_vars.filament == 'ASA' %} 
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_threshold VALUE={start_vars.asa_min_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={start_vars.asa_max_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={start_vars.asa_bed_fan_low_speed}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={start_vars.asa_bed_fan_high_speed}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool VALUE={start_vars.asa_bed_fan_cool}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool_temp VALUE={start_vars.post_print_cool}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE={start_vars.asa_bed_fan_enable}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan_enable VALUE={start_vars.chamber_fan}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_monitor VALUE={start_vars.floating_bed_fans}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={start_vars.floating_bed_fans_max}
      M400

    {% elif core_vars.filament == 'ABS' %} 
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_threshold VALUE={start_vars.abs_min_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={start_vars.abs_max_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={start_vars.abs_bed_fan_low_speed}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={start_vars.abs_bed_fan_high_speed}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool VALUE={start_vars.abs_bed_fan_cool}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool_temp VALUE={start_vars.post_print_cool}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE={start_vars.abs_bed_fan_enable}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan_enable VALUE={start_vars.chamber_fan}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_monitor VALUE={start_vars.floating_bed_fans}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={start_vars.floating_bed_fans_max}
      M400

    {% elif core_vars.filament in ['PET', 'PETG'] %} 
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_threshold VALUE={start_vars.petg_min_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={start_vars.petg_max_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={start_vars.petg_bed_fan_low_speed}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={start_vars.petg_bed_fan_high_speed}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool VALUE={start_vars.petg_bed_fan_cool}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool_temp VALUE={start_vars.post_print_cool}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE={start_vars.petg_bed_fan_enable}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan_enable VALUE={start_vars.chamber_fan}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_monitor VALUE={start_vars.floating_bed_fans}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={start_vars.floating_bed_fans_max}
      M400

    {% elif core_vars.filament in ['FLEX', 'TPU'] %} 
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_threshold VALUE={start_vars.tpu_min_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={start_vars.tpu_max_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={start_vars.tpu_bed_fan_low_speed}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={start_vars.tpu_bed_fan_high_speed}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool VALUE={start_vars.tpu_bed_fan_cool}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool_temp VALUE={start_vars.post_print_cool}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE={start_vars.tpu_bed_fan_enable}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan_enable VALUE={start_vars.chamber_fan}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_monitor VALUE={start_vars.floating_bed_fans}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={start_vars.floating_bed_fans_max}
      M400

    {% else %}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_threshold VALUE={start_vars.default_min_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={start_vars.default_max_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={start_vars.default_bed_fan_low_speed}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={start_vars.default_bed_fan_high_speed}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool VALUE={start_vars.default_bed_fan_cool}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool_temp VALUE={start_vars.post_print_cool}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE={start_vars.default_bed_fan_enable}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan_enable VALUE={start_vars.chamber_fan}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_monitor VALUE={start_vars.floating_bed_fans}
      SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={start_vars.floating_bed_fans_max}
      M400

    {% endif %}



[gcode_macro _CHAMBER_HEATER_SETUP]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}

  {% if core_vars.filament in ['PLA', 'PLA+'] %} 
      SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=min_thresold VALUE={start_vars.pla_min_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=max_thresold VALUE={start_vars.pla_max_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=mid_point VALUE={(start_vars.pla_min_chamber_temp + start_vars.pla_max_chamber_temp) / 2|float}
      M400

    {% elif core_vars.filament == 'ASA' %} 
      SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=min_thresold VALUE={start_vars.asa_min_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=max_thresold VALUE={start_vars.asa_max_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=mid_point VALUE={(start_vars.asa_min_chamber_temp + start_vars.asa_max_chamber_temp) / 2|float}
      M400

    {% elif core_vars.filament == 'ABS' %} 
      SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=min_thresold VALUE={start_vars.abs_min_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=max_thresold VALUE={start_vars.abs_max_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=mid_point VALUE={(start_vars.abs_min_chamber_temp + start_vars.abs_max_chamber_temp) / 2|float}
      M400

    {% elif core_vars.filament in ['PET', 'PETG'] %} 
      SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=min_thresold VALUE={start_vars.petg_min_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=max_thresold VALUE={start_vars.petg_max_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=mid_point VALUE={(start_vars.petg_min_chamber_temp + start_vars.petg_max_chamber_temp) / 2|float}
      M400

    {% elif core_vars.filament in ['FLEX', 'TPU'] %} 
      SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=min_thresold VALUE={start_vars.tpu_min_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=max_thresold VALUE={start_vars.tpu_max_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=mid_point VALUE={(start_vars.tpu_min_chamber_temp + start_vars.tpu_max_chamber_temp) / 2|float}
      M400

    {% else %}
      SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=min_thresold VALUE={start_vars.default_min_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=max_thresold VALUE={start_vars.default_max_chamber_temp}
      SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=mid_point VALUE={(start_vars.default_min_chamber_temp + start_vars.default_max_chamber_temp) / 2|float}
      M400

    {% endif %}

[gcode_macro _CHAMBER_TEMPS_HELPER]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}

  {% if core_vars.filament in ['PLA', 'PLA+'] %} 
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_wait_temp VALUE={start_vars.pla_min_chamber_temp}
    {% if start_vars.chamber_fan == True %}
      SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.pla_max_chamber_temp}
      RESPOND TYPE=COMMAND MSG="Setting Chamber Fan Temp: PLA {start_vars.pla_max_chamber_temp}c"
    {% endif %}

  {% elif core_vars.filament == 'ASA' %}   
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_wait_temp VALUE={start_vars.asa_min_chamber_temp}
    {% if start_vars.chamber_fan == True %}
      SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.asa_max_chamber_temp}
      RESPOND TYPE=COMMAND MSG="Setting Chamber Fan Temp: ASA {start_vars.asa_max_chamber_temp}c"   
    {% endif %}
    
  {% elif core_vars.filament == 'ABS' %} 
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_wait_temp VALUE={start_vars.abs_min_chamber_temp}
    {% if start_vars.chamber_fan == True %}
      SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.abs_max_chamber_temp}
      RESPOND TYPE=COMMAND MSG="Setting Chamber Fan Temp: ABS {start_vars.abs_max_chamber_temp}c"   
    {% endif %}

  {% elif core_vars.filament in ['PET', 'PETG'] %}
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_wait_temp VALUE={start_vars.petg_min_chamber_temp}
    {% if start_vars.chamber_fan == True %}
      SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.petg_max_chamber_temp}
      RESPOND TYPE=COMMAND MSG="Setting Chamber Fan Temp: PETG {start_vars.petg_max_chamber_temp}c"   
    {% endif %}
    
  {% elif core_vars.filament in ['FLEX', 'TPU'] %} 
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_wait_temp VALUE={start_vars.tpu_min_chamber_temp}
    {% if start_vars.chamber_fan == True %}
      SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.tpu_max_chamber_temp}
      RESPOND TYPE=COMMAND MSG="Setting Chamber Fan Temp: TPU {start_vars.tpu_max_chamber_temp}c"   
    {% endif %}
    
  {% else %}
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_wait_temp VALUE={start_vars.default_min_chamber_temp}
    {% if start_vars.chamber_fan == True %}
      SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.default_max_chamber_temp}  
      RESPOND TYPE=COMMAND MSG="Setting Chamber Fan Temp: Default {start_vars.default_max_chamber_temp}c"  
    {% endif %}
    
 {% endif %}

 

[gcode_macro _START_WAIT_AND_TIMER_HANDLING]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}

  {% if core_vars.chamber_thermal_sensor|int == 0 %}
    {action_raise_error("This error is caused by no correctly named chamber_sensor or temperature controlled chamber_fan being available to the system! Check the system is setup correctly!")}  

  {% elif core_vars.chamber_thermal_sensor|int == 1 %}
    {% set thermal_sensor = printer["temperature_fan chamber"].temperature|float %}

  {% elif core_vars.chamber_thermal_sensor|int == 2 %}
    {% set thermal_sensor = printer["temperature_sensor Chamber_Temp"].temperature|float %}
  {% endif %}

  {% if start_vars.chamber_fan == True and start_vars.chamber_sensor == True %} 
    {action_raise_error("This error is caused by you setting both the chamber_fan & chamber_sensor to true. Check demon_user_settings file & set these correctly for your printer!")}
  {% endif %}
    
  {% if core_vars.chamber_thermal_sensor in range((1|int), (3|int)) and start_vars.chamber_temp_wait == True %}
    {% if thermal_sensor|float < core_vars.heat_wait_temp|int %}
      {% if start_vars.bed_checker_enable == True %}
        {% if core_vars.heat_soaked == True %}
          {% if core_vars.bed_state|float <= core_vars.bed|int * 0.60 %}
            RESPOND TYPE=COMMAND MSG="The system chose to run a BED_CHECKER heat soak as the bed was too cold"
            _BED_CHECKER_STARTER
            
          {% else %}
            _TEMP_WAIT
          {% endif %}
    
        {% else %}
          RESPOND TYPE=COMMAND MSG="The system chose to run BED_CHECKER as the printer did not meet the previously heat soaked conditions"
          _BED_CHECKER_STARTER
        {% endif %}
            
      {% else %}
        _TEMP_WAIT
      {% endif %}
      
    {% else %}
      {% if start_vars.bed_checker_enable == True %}
        {% if core_vars.bed_state|float <= core_vars.bed|int * 0.60 %}
          RESPOND TYPE=COMMAND MSG="The system chose to run a BED_CHECKER heat soak as the bed was too cold"
          _BED_CHECKER_STARTER

        {% else %}
          SET_DISPLAY_TEXT MSG="Already up to {core_vars.filament} temp, heat soak skipped"
          RESPOND TYPE=COMMAND MSG="Already up to {core_vars.filament} temp, heat soak skipped"
          G4 P5000

          SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=stage_one_end VALUE=True
          _DEMON_START_STAGE_TWO
        {% endif %}

      {% else %}
        SET_DISPLAY_TEXT MSG="Already up to {core_vars.filament} temp, heat soak skipped"
        RESPOND TYPE=COMMAND MSG="Already up to {core_vars.filament} temp, heat soak skipped"
        G4 P5000

        SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=stage_one_end VALUE=True
        _DEMON_START_STAGE_TWO
      {% endif %}
    {% endif %}

  {% else %}
    {% if start_vars.bed_checker_enable == True and start_vars.force_bed_checker == True %}
      RESPOND TYPE=COMMAND MSG="The system was forced to run a BED_CHECKER heat soak"
      _BED_CHECKER_STARTER

    {% else %}
      _SMART_HEAT_SOAK_TIMER
    {% endif %}
  {% endif %}


[gcode_macro _TEMP_WAIT]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}

  {% if core_vars.chamber_thermal_sensor|int == 0 %}
    {action_raise_error("This error is caused by no correctly named chamber_sensor or temperature controlled chamber_fan being available to the system! Check the system is setup correctly!")}  

  {% elif core_vars.chamber_thermal_sensor|int == 1 %}
    {% set wait_thermal_sensor = "temperature_fan chamber"|string %}

  {% elif core_vars.chamber_thermal_sensor|int == 2 %}
    {% set wait_thermal_sensor = "temperature_sensor Chamber_Temp"|string %}
  {% endif %}
  
    _Z_PARK
    SET_DISPLAY_TEXT MSG="Waiting For Chamber Temp: {core_vars.heat_wait_temp}c"
    RESPOND TYPE=COMMAND MSG="Waiting For Chamber Temp: {core_vars.heat_wait_temp}c"
    TEMPERATURE_WAIT SENSOR="{wait_thermal_sensor}" MINIMUM={core_vars.heat_wait_temp|float -1}
    RESPOND TYPE=COMMAND MSG="Chamber Temp Reached"
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_soaked VALUE=True
    SAVE_VARIABLE VARIABLE=heat_soaked VALUE=True

    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=stage_one_end VALUE=True
    _DEMON_START_STAGE_TWO



[gcode_macro _SMART_HEAT_SOAK_TIMER]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}

  {% if start_vars.lo_temp_timer <= 1 %}
    {action_raise_error("ERROR: Low Temp Timer is set to 1 minute or less! This value is not divisible by the Smart Heat Soak system. Set timer to more than 1 minute!")}

  {% elif start_vars.hi_temp_timer <= 1 %}
    {action_raise_error("ERROR: High Temp Timer is set to 1 minute or less! This value is not divisible by the Smart Heat Soak system. Set timer to more than 1 minute!")}
  {% endif %}
    
    _Z_PARK

  {% if core_vars.filament not in ['PLA', 'PLA+', 'PET', 'PETG', 'FLEX', 'TPU', 'ASA', 'ABS'] %}
    {% if core_vars.heat_soaked == True %}
      {% if core_vars.bed_state|float <= core_vars.bed|int * 0.60 %}
        {% if start_vars.bed_checker_enable == True %}
          RESPOND TYPE=COMMAND MSG="The system chose to run a BED_CHECKER heat soak as the bed was too cold"
          _BED_CHECKER_STARTER

        {% else %}
          RESPOND TYPE=COMMAND MSG="Smart Heat Soak: Running full Default Temp Timer! Bed was too cold!"
          _HEAT_WAIT MSG="Smart Heat Soak" MINUTES={start_vars.default_temp_timer|int}
          _POST_SMART_SOAK
        {% endif %}
          
      {% elif core_vars.bed_state|float > core_vars.bed|int * 0.60 and core_vars.bed_state|float <= core_vars.bed|int * 0.75 %}
        RESPOND TYPE=COMMAND MSG="Smart Heat Soak: Running Default Temp Timer at 75% time! Bed was cooling!"
        _HEAT_WAIT MSG="Smart Heat Soak 75%" MINUTES={start_vars.default_temp_timer|int * 0.75}
        _POST_SMART_SOAK

      {% elif core_vars.bed_state|float > core_vars.bed|int * 0.75 and core_vars.bed_state|float < core_vars.bed|int * 0.90 %}
        RESPOND TYPE=COMMAND MSG="Smart Heat Soak: Running Default Temp Timer at 50% time! Bed is still warm!"
        _HEAT_WAIT MSG="Smart Heat Soak 50%" MINUTES={start_vars.default_temp_timer|int * 0.5}
        _POST_SMART_SOAK

      {% elif core_vars.bed_state|float >= core_vars.bed|int * 0.90 and core_vars.bed_state|float <= core_vars.bed|int * 1.2%}
        RESPOND TYPE=COMMAND MSG="Smart Heat Soak: Heat Soak previously done & bed still in thermal range, skipping timer!"
        _POST_SMART_SOAK

      {% elif core_vars.bed_state|float > core_vars.bed|int * 1.2 %}
        RESPOND TYPE=COMMAND MSG="Smart Heat Soak: Running Default Temp Timer at 75% time! Bed was too hot!"
        _HEAT_WAIT MSG="Smart Heat Soak 75%" MINUTES={start_vars.default_temp_timer|int * 0.75}
        _POST_SMART_SOAK
      {% endif %}

    {% else %}
      {% if start_vars.bed_checker_enable == True %}
        RESPOND TYPE=COMMAND MSG="The system chose to run BED_CHECKER as the printer did not meet the previously heat soaked conditions"
        _BED_CHECKER_STARTER

      {% else %}
        RESPOND TYPE=COMMAND MSG="Smart Heat Soak: Running Default Temp Timer. Heat soak not previously run or bed was too cold!"
        _HEAT_WAIT MSG="Smart Heat Soak" MINUTES={start_vars.default_temp_timer|int}
        _POST_SMART_SOAK
      {% endif %}
    {% endif %}
    
  {% elif core_vars.filament in ['PLA', 'PLA+', 'PET', 'PETG', 'FLEX', 'TPU'] or core_vars.bed|int < 90 %}
    {% if core_vars.heat_soaked == True %}
      {% if core_vars.bed_state|float <= core_vars.bed|int * 0.60 %}
        {% if start_vars.bed_checker_enable == True %}
          RESPOND TYPE=COMMAND MSG="The system chose to run a BED_CHECKER heat soak as the bed was too cold"
          _BED_CHECKER_STARTER

        {% else %}
          RESPOND TYPE=COMMAND MSG="Smart Heat Soak: Running full Low Temp Timer! Bed was too cold!"
          _HEAT_WAIT MSG="Smart Heat Soak" MINUTES={start_vars.lo_temp_timer|int}
          _POST_SMART_SOAK
        {% endif %}
          
      {% elif core_vars.bed_state|float > core_vars.bed|int * 0.60 and core_vars.bed_state|float <= core_vars.bed|int * 0.75 %}
        RESPOND TYPE=COMMAND MSG="Smart Heat Soak: Running Low Temp Timer at 75% time! Bed was cooling!"
        _HEAT_WAIT MSG="Smart Heat Soak 75%" MINUTES={start_vars.lo_temp_timer|int * 0.75}
        _POST_SMART_SOAK

      {% elif core_vars.bed_state|float > core_vars.bed|int * 0.75 and core_vars.bed_state|float < core_vars.bed|int * 0.90 %}
        RESPOND TYPE=COMMAND MSG="Smart Heat Soak: Running Low Temp Timer at 50% time! Bed is still warm!"
        _HEAT_WAIT MSG="Smart Heat Soak 50%" MINUTES={start_vars.lo_temp_timer|int * 0.5}
        _POST_SMART_SOAK

      {% elif core_vars.bed_state|float >= core_vars.bed|int * 0.90 and core_vars.bed_state|float <= core_vars.bed|int * 1.2%}
        RESPOND TYPE=COMMAND MSG="Smart Heat Soak: Heat Soak previously done & bed still in thermal range, skipping timer!"
        _POST_SMART_SOAK

      {% elif core_vars.bed_state|float > core_vars.bed|int * 1.2 %}
        RESPOND TYPE=COMMAND MSG="Smart Heat Soak: Running Low Temp Timer at 75% time! Bed was too hot!"
        _HEAT_WAIT MSG="Smart Heat Soak 75%" MINUTES={start_vars.lo_temp_timer|int * 0.75}
        _POST_SMART_SOAK
      {% endif %}

    {% else %}
      {% if start_vars.bed_checker_enable == True %}
        RESPOND TYPE=COMMAND MSG="The system chose to run BED_CHECKER as the printer did not meet the previously heat soaked conditions"
        _BED_CHECKER_STARTER

      {% else %}
        RESPOND TYPE=COMMAND MSG="Smart Heat Soak: Running Low Temp Timer. Heat soak not previously run or bed was too cold!"
        _HEAT_WAIT MSG="Smart Heat Soak" MINUTES={start_vars.lo_temp_timer|int}
        _POST_SMART_SOAK
      {% endif %}
    {% endif %}
    
  {% elif core_vars.filament in ['ASA', 'ABS'] or core_vars.bed|int >= 90 %}
    {% if core_vars.heat_soaked == True %}
      {% if core_vars.bed_state|float <= core_vars.bed|int * 0.70 %}
        {% if start_vars.bed_checker_enable == True %}
          RESPOND TYPE=COMMAND MSG="The system chose to run a BED_CHECKER heat soak as the bed was too cold"
          _BED_CHECKER_STARTER

        {% else %}
          RESPOND TYPE=COMMAND MSG="Smart Heat Soak: Running full High Temp Timer! Bed was too cold!"
          _HEAT_WAIT MSG="Smart Heat Soak" MINUTES={start_vars.hi_temp_timer|int}
          _POST_SMART_SOAK
        {% endif %}
          
      {% elif core_vars.bed_state|float > core_vars.bed|int * 0.70 and core_vars.bed_state|float <= core_vars.bed|int * 0.80 %}
        RESPOND TYPE=COMMAND MSG="Smart Heat Soak: Running High Temp Timer at 75% time! Bed was cooling!"
        _HEAT_WAIT MSG="Smart Heat Soak 75%" MINUTES={start_vars.hi_temp_timer|int * 0.75}
        _POST_SMART_SOAK

      {% elif core_vars.bed_state|float > core_vars.bed|int * 0.80 and core_vars.bed_state|float < core_vars.bed|int * 0.90 %}
        RESPOND TYPE=COMMAND MSG="Smart Heat Soak: Running High Temp Timer at 50% time! Bed is still warm!"
        _HEAT_WAIT MSG="Smart Heat Soak 50%" MINUTES={start_vars.hi_temp_timer|int * 0.5}
        _POST_SMART_SOAK

      {% elif core_vars.bed_state|float >= core_vars.bed|int * 0.90 and core_vars.bed_state|float <= core_vars.bed|int * 1.2%}
        RESPOND TYPE=COMMAND MSG="Smart Heat Soak: Heat Soak previously done & bed still in thermal range, skipping timer!"
        _POST_SMART_SOAK

      {% elif core_vars.bed_state|float > core_vars.bed|int * 1.2 %}
        RESPOND TYPE=COMMAND MSG="Smart Heat Soak: Running High Temp Timer at 75% time! Bed was too hot!"
        _HEAT_WAIT MSG="Smart Heat Soak 75%" MINUTES={start_vars.hi_temp_timer|int * 0.75}
        _POST_SMART_SOAK
      {% endif %}

    {% else %}
      {% if start_vars.bed_checker_enable == True %}
        RESPOND TYPE=COMMAND MSG="The system chose to run BED_CHECKER as the printer did not meet the previously heat soaked conditions"
        _BED_CHECKER_STARTER

      {% else %}
        RESPOND TYPE=COMMAND MSG="Smart Heat Soak: Running High Temp Timer. Heat soak not previously run or bed was too cold!"
        _HEAT_WAIT MSG="Smart Heat Soak" MINUTES={start_vars.hi_temp_timer|int}
        _POST_SMART_SOAK
      {% endif %}
    {% endif %}
  {% endif %}



[gcode_macro _POST_SMART_SOAK]
gcode:

    M400
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=stage_one_end VALUE=True
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_soaked VALUE=True
    SAVE_VARIABLE VARIABLE=heat_soaked VALUE=True
    M400
    _DEMON_START_STAGE_TWO



[gcode_macro _BED_STATE_CHECKER]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}

  SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=bed_state VALUE={printer.heater_bed.temperature|float}

  {% if printer.heater_bed.temperature|int < 40 %}
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_soaked VALUE=False
    SAVE_VARIABLE VARIABLE=heat_soaked VALUE=False
  {% endif %}

  
   
[gcode_macro _MESH_HANDLING]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}

  {% if start_vars.adaptive_meshing == True %}

    {% if ('probe_eddy_ng btt_eddy' in printer) or ('probe_eddy_ng eddy' in printer) or ('mcu eddy' in printer.configfile.config) or ('probe_eddy_current btt_eddy' in printer) or ('probe_eddy_current eddy' in printer) %}
      BED_MESH_CALIBRATE METHOD=rapid_scan ADAPTIVE=1 ADAPTIVE_MARGIN=10
      M400
      G0 Z{core_vars.z_park} F3600

    {% else %}
      {% if 'cartographer' in printer.configfile.config %}
        CARTOGRAPHER_TOUCH_HOME
        M400
      {% endif %}
       
      BED_MESH_CALIBRATE ADAPTIVE=1 ADAPTIVE_MARGIN=10
      M400
      G0 Z{core_vars.z_park} F3600
    {% endif %}

    {% if (printer.configfile.config.stepper_z.endstop_pin == 'probe:z_virtual_endstop') or (printer.configfile.config.stepper_z.endstop_pin == 'probe: z_virtual_endstop') %}
      {% if start_vars.klicky_probe == True %}
        Dock_Probe_Unlock
        {% if start_vars.nozzle_cleaner == True %}
          CLEAN_NOZZLE
          # _Z_PARK
        {% endif %}
  
      {% else %}
        {% if ('probe_eddy_ng btt_eddy' in printer) or ('probe_eddy_ng eddy' in printer) or ('probe_eddy_current btt_eddy' in printer) or ('probe_eddy_current eddy' in printer) %}
        {% else %}
          {% if start_vars.nozzle_cleaner == True %}
            CLEAN_NOZZLE
            # _Z_PARK
          {% endif %}
        {% endif %}
      {% endif %}
    {% endif %}
   
  {% else %}  
    {% if core_vars.filament in ['PLA', 'PLA+'] %}
      {% if 'bed_mesh default' in printer.configfile.config %}
        BED_MESH_PROFILE LOAD="default"
        RESPOND TYPE=COMMAND MSG="Default mesh loaded"
      {% else %}
        {action_raise_error("ERROR: There is no recognised default mesh available, please build & save one to continue!")}
      {% endif %}

    {% elif core_vars.filament == 'ASA' %} 
      {% if 'bed_mesh ASA' in printer.configfile.config %}
        BED_MESH_PROFILE LOAD="ASA"
        RESPOND TYPE=COMMAND MSG="ASA mesh loaded"
      {% else %}
        {action_raise_error("ERROR: There is no recognised ASA mesh available, please build & save one to continue!")}
      {% endif %}
    
    {% elif core_vars.filament == 'ABS' %}
      {% if 'bed_mesh ABS' in printer.configfile.config %}
        BED_MESH_PROFILE LOAD="ABS"
        RESPOND TYPE=COMMAND MSG="ABS mesh loaded"
      {% else %}
        {action_raise_error("ERROR: There is no recognised ABS mesh available, please build & save one to continue!")}
      {% endif %}
    
    {% elif core_vars.filament in ['PET', 'PETG'] %}
      {% if 'bed_mesh PETG' in printer.configfile.config %}
        BED_MESH_PROFILE LOAD="PETG"  
        RESPOND TYPE=COMMAND MSG="PETG mesh loaded"
      {% else %}
        {action_raise_error("ERROR: There is no recognised PETG mesh available, please build & save one to continue!")}
      {% endif %}
    
    {% elif core_vars.filament in ['FLEX', 'TPU'] %}
      {% if 'bed_mesh TPU' in printer.configfile.config %}
        BED_MESH_PROFILE LOAD="TPU"  
        RESPOND TYPE=COMMAND MSG="TPU mesh loaded"
      {% else %}
        {action_raise_error("ERROR: There is no recognised TPU mesh available, please build & save one to continue!")}
      {% endif %}

    {% else %}    
      {% if core_vars.bed|float < 90 %}
        {% if 'bed_mesh default' in printer.configfile.config %}
          BED_MESH_PROFILE LOAD="default"
          RESPOND TYPE=COMMAND MSG="Default mesh by temp loaded"
        {% else %}
          {action_raise_error("ERROR: There is no recognised default mesh available, please build & save one to continue!")}
        {% endif %}

      {% else %}
        {% if 'bed_mesh ASA' in printer.configfile.config %}
          BED_MESH_PROFILE LOAD="ASA" 
          RESPOND TYPE=COMMAND MSG="ASA mesh by temp loaded"
          
        {% elif 'bed_mesh ABS' in printer.configfile.config %}
          BED_MESH_PROFILE LOAD="ABS" 
          RESPOND TYPE=COMMAND MSG="ABS mesh by temp loaded"

        {% elif 'bed_mesh ASA' not in printer.configfile.config and 'bed_mesh ABS' not in printer.configfile.config %}
          {action_raise_error("ERROR: There are no recognised high temperature meshes available, please build an ASA or ABS mesh & save it to continue!")}
        {% endif %} 
      {% endif %}    
    {% endif %}

    M400
    {% if 'cartographer' in printer.configfile.config %}
      CARTOGRAPHER_TOUCH_HOME
    {% endif %}  
  {% endif %}



[gcode_macro _EDDY_NG_TAP]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}

    _EDDY_NG_RANDOM_TAP_GEN 
  {% if start_vars.nozzle_cleaner == True %}
    CLEAN_NOZZLE
  {% endif %}
    
  {% if start_vars.eddy_ng_tap_bed_off == True %}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0
  {% endif %}
  
    _GO_EDDY_NG_TAP
    M400
    PROBE_EDDY_NG_TAP
    M400
  {% if start_vars.eddy_ng_tap_bed_off == True %}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={core_vars.bed}
  {% endif %}
    # G0 Z{core_vars.z_park}

    

[gcode_macro _GO_EDDY_NG_TAP_VARIABLES]
variable_random_tap_spot_x: 35
variable_random_tap_spot_y: 35
variable_custom_random_tap_spot_x: 35
variable_custom_random_tap_spot_y: 35
gcode:



[gcode_macro _GO_EDDY_NG_TAP]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set eddy_ng_tap_vars = printer["gcode_macro _GO_EDDY_NG_TAP_VARIABLES"] %}

  {% if start_vars.eddy_ng_custom_tap_spot == False and start_vars.eddy_ng_random_tap == True %}
    _Z_PARK
    G91
    G0 X{eddy_ng_tap_vars.random_tap_spot_x} Y{eddy_ng_tap_vars.random_tap_spot_y} F9000
    G90

  {% elif start_vars.eddy_ng_custom_tap_spot == True and start_vars.eddy_ng_random_tap == True %}
    G0 X{eddy_ng_tap_vars.custom_random_tap_spot_x} Y{eddy_ng_tap_vars.custom_random_tap_spot_y} F9000
    
  {% elif start_vars.eddy_ng_custom_tap_spot == True and start_vars.eddy_ng_random_tap == False %}
    G0 X{start_vars.eddy_ng_custom_tap_spot_x} Y{start_vars.eddy_ng_custom_tap_spot_y} F9000
  
  {% else %}
    _Z_PARK
  {% endif %}

    G0 Z2 F3600
    G4 P1000
    M400
    PROBE_EDDY_NG_PROBE_STATIC HOME_Z=1


    
[gcode_macro _EDDY_NG_RANDOM_TAP_GEN]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set random_tap_lo = (start_vars.eddy_ng_random_tap_range|int / 2) - start_vars.eddy_ng_random_tap_range|int %}
  {% set random_tap_hi = (start_vars.eddy_ng_random_tap_range|int / 2) %}
  {% set random_x = range((random_tap_lo|int), (random_tap_hi|int))|random %}
  {% set random_y = range((random_tap_lo|int), (random_tap_hi|int))|random %}

    SET_GCODE_VARIABLE MACRO=_GO_EDDY_NG_TAP_VARIABLES VARIABLE=random_tap_spot_x VALUE={random_x|int}
    SET_GCODE_VARIABLE MACRO=_GO_EDDY_NG_TAP_VARIABLES VARIABLE=random_tap_spot_y VALUE={random_y|int}
    SET_GCODE_VARIABLE MACRO=_GO_EDDY_NG_TAP_VARIABLES VARIABLE=custom_random_tap_spot_x VALUE={(start_vars.eddy_ng_custom_tap_spot_x|int + random_x|int)}
    SET_GCODE_VARIABLE MACRO=_GO_EDDY_NG_TAP_VARIABLES VARIABLE=custom_random_tap_spot_y VALUE={(start_vars.eddy_ng_custom_tap_spot_x|int + random_y|int)}

  
  
[gcode_macro _ORCA_MULTI_SURFACE_HANDLING]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set surface = printer["gcode_macro _CORE_VARS"].orca_surface %}
  # {% set surface = params.SURFACE|default('High Temp Plate')|string %}
  
 
  {% if start_vars.orca_multi_surface == True %}
    {% if surface == 'Cool Plate' %}
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=orca_bed_offset VALUE={start_vars.orca_cool_plate}

    {% elif surface == 'High Temp Plate' %}
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=orca_bed_offset VALUE={start_vars.orca_smooth_hi_temp_plate}
      
    {% elif surface == 'Textured PEI Plate' %}
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=orca_bed_offset VALUE={start_vars.orca_textured_pei_plate}

    {% elif surface == 'Engineering Plate' %}
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=orca_bed_offset VALUE={start_vars.orca_engineering_plate}

    {% elif surface == 'Textured Cool Plate' %}
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=orca_bed_offset VALUE={start_vars.orca_textured_cool_plate}
        
    {% endif %}
      
  {% endif %}



[gcode_macro _Z_OFFSET_HANDLING]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}

  {% if start_vars.orca_enable == True and start_vars.orca_multi_surface == True and start_vars.combine_offset == True %}
    {% if core_vars.orca_bed_offset >= -0.165 and core_vars.orca_bed_offset <= 0.165 %}
      {% if core_vars.filament in ['PLA', 'PLA+'] %}
        {% if core_vars.orca_bed_offset == 0.00 %}
          SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
          RESPOND TYPE=COMMAND MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
        {% elif core_vars.orca_bed_offset != 0.00 %}
          SET_GCODE_OFFSET Z_ADJUST={core_vars.orca_bed_offset} MOVE=1
          SET_DISPLAY_TEXT MSG="BED TYPE: Applying {core_vars.orca_surface} offset adjustment"
          RESPOND TYPE=echo MSG="BED TYPE: Applying {core_vars.orca_surface} offset adjustment"
        {% endif %}

      {% elif start_vars.high_temp_expansion_offset == True and core_vars.filament in ['ASA', 'ABS'] %}
        {% if start_vars.high_temp_offset >= -0.165 and start_vars.high_temp_offset <= 0.165 %}
          {% if core_vars.orca_bed_offset == 0.00 %}
            SET_GCODE_OFFSET Z_ADJUST={start_vars.high_temp_offset} MOVE=1 # <<<<<<<<<<<<<<<<<<< Use with EXTREME caution!! Manual G-Code Z offset override!
            SET_DISPLAY_TEXT MSG="REQUESTED HIGH TEMP OFFSET ADJUSTMENT APPLIED"
            RESPOND TYPE=echo MSG="REQUESTED HIGH TEMP OFFSET ADJUSTMENT APPLIED"
          {% elif core_vars.orca_bed_offset != 0.00 %}
            {% if (start_vars.high_temp_offset + core_vars.orca_bed_offset) >= -0.165 and (start_vars.high_temp_offset + core_vars.orca_bed_offset) <= 0.165 %}
              SET_GCODE_OFFSET Z_ADJUST={start_vars.high_temp_offset + core_vars.orca_bed_offset} MOVE=1 # <<<<<<<<<<<<<<<<<<< Use with EXTREME caution!! Manual G-Code Z offset override!
              SET_DISPLAY_TEXT MSG="BED TYPE: Applying {core_vars.orca_surface} & High Temp combined offset adjustment"
              RESPOND TYPE=echo MSG="BED TYPE: Applying {core_vars.orca_surface} & High Temp combined offset adjustment"
            {% else %}
              {action_emergency_stop("EMERGENCY STOP! EXCESSIVE HIGH TEMP OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")} # M112
            {% endif %}    
          {% endif %} 
        {% else %}
          {action_emergency_stop("EMERGENCY STOP! EXCESSIVE HIGH TEMP OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")} # M112
        {% endif %}
          G4 P10000

      {% elif start_vars.petg_anti_squish == True and core_vars.filament in ['PET', 'PETG'] %}
        {% if start_vars.petg_offset >= 0.0 and start_vars.petg_offset <= 0.165 %}
          {% if core_vars.orca_bed_offset == 0.00 %}
            SET_GCODE_OFFSET Z_ADJUST={start_vars.petg_offset} MOVE=1 # <<<<<<<<<<<<<<<<<<< Use with EXTREME caution!! Manual G-Code Z offset override!
            SET_DISPLAY_TEXT MSG="REQUESTED PETG OFFSET ADJUSTMENT APPLIED"
            RESPOND TYPE=echo MSG="REQUESTED PETG OFFSET ADJUSTMENT APPLIED"
          {% elif core_vars.orca_bed_offset != 0.00 %}
            {% if (start_vars.petg_offset + core_vars.orca_bed_offset) >= -0.165 and (start_vars.petg_offset + core_vars.orca_bed_offset) <= 0.165 %}
              SET_GCODE_OFFSET Z_ADJUST={start_vars.petg_offset + core_vars.orca_bed_offset} MOVE=1 # <<<<<<<<<<<<<<<<<<< Use with EXTREME caution!! Manual G-Code Z offset override!
              SET_DISPLAY_TEXT MSG="BED TYPE: Applying {core_vars.orca_surface} & PETG Anti Squish combined offset adjustment"
              RESPOND TYPE=echo MSG="BED TYPE: Applying {core_vars.orca_surface} & PETG Anti Squish combined offset adjustment"
            {% else %}
             {action_emergency_stop("EMERGENCY STOP! NEGATIVE OR EXCESSIVE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")} # M112
            {% endif %}  
          {% endif %}
        {% else %}
          {action_emergency_stop("EMERGENCY STOP! NEGATIVE OR EXCESSIVE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")} # M112
        {% endif %}
          G4 P10000

      {% elif start_vars.tpu_anti_squish == True and core_vars.filament in ['FLEX','TPU'] %}
        {% if start_vars.tpu_offset >= 0.0 and start_vars.tpu_offset <= 0.165 %}
          {% if core_vars.orca_bed_offset == 0.00 %}
            SET_GCODE_OFFSET Z_ADJUST={start_vars.tpu_offset} MOVE=1 # <<<<<<<<<<<<<<<<<<< Use with EXTREME caution!! Manual G-Code Z offset override!
            SET_DISPLAY_TEXT MSG="REQUESTED TPU OFFSET ADJUSTMENT APPLIED"
            RESPOND TYPE=echo MSG="REQUESTED TPU OFFSET ADJUSTMENT APPLIED"
          {% elif core_vars.orca_bed_offset != 0.00 %}
           {% if (start_vars.tpu_offset + core_vars.orca_bed_offset) >= -0.165 and (start_vars.tpu_offset + core_vars.orca_bed_offset) <= 0.165 %}
              SET_GCODE_OFFSET Z_ADJUST={start_vars.tpu_offset + core_vars.orca_bed_offset} MOVE=1 # <<<<<<<<<<<<<<<<<<< Use with EXTREME caution!! Manual G-Code Z offset override!
              SET_DISPLAY_TEXT MSG="BED TYPE: Applying {core_vars.orca_surface} & TPU Anti Squish combined offset adjustment"
              RESPOND TYPE=echo MSG="BED TYPE: Applying {core_vars.orca_surface} & TPU Anti Squish combined offset adjustment"
            {% else %}
              {action_emergency_stop("EMERGENCY STOP! NEGATIVE OR EXCESSIVE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")} # M112
            {% endif %}
            
          {% endif %}
        {% else %}
          {action_emergency_stop("EMERGENCY STOP! NEGATIVE OR EXCESSIVE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")} # M112
        {% endif %}
          G4 P10000  

      {% elif start_vars.high_temp_expansion_offset == False and core_vars.filament in ['ASA', 'ABS'] %}
        {% if core_vars.orca_bed_offset == 0.00 %}
          SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
          RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
        {% elif core_vars.orca_bed_offset != 0.00 %}
          SET_GCODE_OFFSET Z_ADJUST={core_vars.orca_bed_offset} MOVE=1 # <<<<<<<<<<<<<<<<<<< Use with EXTREME caution!! Manual G-Code Z offset override!
          SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
          RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
        {% endif %}

      {% elif start_vars.petg_anti_squish == False and core_vars.filament in ['PET', 'PETG'] %}
        {% if core_vars.orca_bed_offset == 0.00 %}
          SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
          RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
        {% elif core_vars.orca_bed_offset != 0.00 %}
          SET_GCODE_OFFSET Z_ADJUST={core_vars.orca_bed_offset} MOVE=1 # <<<<<<<<<<<<<<<<<<< Use with EXTREME caution!! Manual G-Code Z offset override!
          SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
          RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
        {% endif %}

      {% elif start_vars.tpu_anti_squish == False and core_vars.filament in ['FLEX','TPU'] %}
        {% if core_vars.orca_bed_offset == 0.00 %}
          SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
          RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
        {% elif core_vars.orca_bed_offset != 0.00 %}
          SET_GCODE_OFFSET Z_ADJUST={core_vars.orca_bed_offset} MOVE=1 # <<<<<<<<<<<<<<<<<<< Use with EXTREME caution!! Manual G-Code Z offset override!
          SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
          RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
        {% endif %}
      {% endif %}

        
    {% else %}
      {action_emergency_stop("EMERGENCY STOP! EXCESSIVE PLATE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")} # M112
    {% endif %} 


  {% elif start_vars.orca_enable == True and start_vars.orca_multi_surface == True and start_vars.combine_offset == False %}
    {% if core_vars.orca_bed_offset >= -0.165 and core_vars.orca_bed_offset <= 0.165 %} 
      {% if core_vars.orca_bed_offset == 0.00 %}
        SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} SELECTED. NO OFFSET APPLIED"
        RESPOND TYPE=COMMAND MSG="BED TYPE: {core_vars.orca_surface} SELECTED. NO OFFSET APPLIED"
        G4 P10000 
      {% elif core_vars.orca_bed_offset != 0.00 %}
        SET_GCODE_OFFSET Z_ADJUST={core_vars.orca_bed_offset} MOVE=1
        SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
        RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED" 
        G4 P10000 
      {% endif %} 
      
    {% else %}
      {action_emergency_stop("EMERGENCY STOP! EXCESSIVE PLATE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")} # M112
    {% endif %} 

  
  {% elif start_vars.orca_enable == True and start_vars.orca_multi_surface == False and start_vars.combine_offset == True %}
    {action_raise_error("This error is caused by variable_orca_multi_surface being set to False when combine_offset is set to True! Check demon_user_settings file!")}

  {% elif (start_vars.orca_enable == False) and (start_vars.orca_multi_surface == True or start_vars.combine_offset == True) %}
    {action_raise_error("This error is caused by variable_orca_multi_surface &/or combine_offset are set to True when is orca_enable set to False! Check demon_user_settings file!")}

    
  {% elif start_vars.orca_multi_surface == False and start_vars.combine_offset == False %}
  
    {% if start_vars.high_temp_expansion_offset == True and core_vars.filament in ['ASA', 'ABS'] %}
      {% if start_vars.high_temp_offset >= -0.165 and start_vars.high_temp_offset <= 0.165 %}
        SET_GCODE_OFFSET Z_ADJUST={start_vars.high_temp_offset} MOVE=1 # <<<<<<<<<<<<<<<<<<< Use with EXTREME caution!! Manual G-Code Z offset override!
        SET_DISPLAY_TEXT MSG="REQUESTED HIGH TEMP OFFSET ADJUSTMENT APPLIED"
        RESPOND TYPE=echo MSG="REQUESTED HIGH TEMP OFFSET ADJUSTMENT APPLIED"
        G4 P10000

      {% else %}
        {action_emergency_stop("EMERGENCY STOP! EXCESSIVE HIGH TEMP OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")} # M112
      {% endif %}    

    {% elif start_vars.petg_anti_squish == True and core_vars.filament in ['PET', 'PETG'] %}
      {% if start_vars.petg_offset >= 0.0 and start_vars.petg_offset <= 0.165 %}
        SET_GCODE_OFFSET Z_ADJUST={start_vars.petg_offset} MOVE=1 # <<<<<<<<<<<<<<<<<<< Use with EXTREME caution!! Manual G-Code Z offset override!
        SET_DISPLAY_TEXT MSG="REQUESTED PETG OFFSET ADJUSTMENT APPLIED"
        RESPOND TYPE=echo MSG="REQUESTED PETG OFFSET ADJUSTMENT APPLIED"
        G4 P10000

      {% else %}
        {action_emergency_stop("EMERGENCY STOP! NEGATIVE OR EXCESSIVE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")} # M112
      {% endif %}  

    {% elif start_vars.tpu_anti_squish == True and core_vars.filament in ['FLEX','TPU'] %}
      {% if start_vars.tpu_offset >= 0.0 and start_vars.tpu_offset <= 0.165 %}
        SET_GCODE_OFFSET Z_ADJUST={start_vars.tpu_offset} MOVE=1 # <<<<<<<<<<<<<<<<<<< Use with EXTREME caution!! Manual G-Code Z offset override!
        SET_DISPLAY_TEXT MSG="REQUESTED TPU OFFSET ADJUSTMENT APPLIED"
        RESPOND TYPE=echo MSG="REQUESTED TPU OFFSET ADJUSTMENT APPLIED"
        G4 P10000   

      {% else %}
        {action_emergency_stop("EMERGENCY STOP! NEGATIVE OR EXCESSIVE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")} # M112
      {% endif %}  
    {% endif %}
  {% endif %}



[gcode_macro _ORCA_OFFSET_REMOVE]
variable_z: 0.00
gcode:
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}

    {% if core_vars.orca_bed_offset != 0.00 %}
      SET_GCODE_OFFSET Z=0.00
      SET_DISPLAY_TEXT MSG="Resetting offset due to applied Orca offset modifer"
      RESPOND TYPE=COMMAND MSG="Resetting offset due to applied Orca offset modifer"
    {% endif %} 



[gcode_macro _EDDY_OFFSET_REMOVE]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}

  {% if 'mcu eddy' in printer and 'probe_eddy_current btt_eddy' in printer %}
    {% if printer.gcode_move.homing_origin.z != 0.00 %}
      SET_GCODE_OFFSET Z=0
      RESPOND TYPE=COMMAND MSG="Removing Eddy auto offset"
    {% endif %}

  {% elif 'mcu eddy' in printer and 'probe_eddy_ng btt_eddy' in printer %}
     RESPOND TYPE=COMMAND MSG="EDDY OFFSET REMOVE: BTT Eddy Duo or USB probe was found running Eddy NG, this option is only for use with the stock none offset adjustable cfg file from BTT for BTT Eddy probes. You should turn the Eddy offset remove option off!"

  {% elif 'mcu eddy' in printer and 'probe_eddy_ng eddy' in printer %}
     RESPOND TYPE=COMMAND MSG="EDDY OFFSET REMOVE: An Eddy probe was found running Eddy NG, this option is only for use with the stock none offset adjustable cfg file from BTT for BTT Eddy probes. You should turn the Eddy offset remove option off!"
     
  {% else %}
    RESPOND TYPE=COMMAND MSG="EDDY OFFSET REMOVE: BTT Eddy Duo or USB probe not present, this option is only for use with the stock none offset adjustable cfg file from BTT for BTT Eddy probes. You should turn the Eddy offset remove option off!"
  {% endif %} 



[gcode_macro _OFFSET_RESET_CONTROL]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}

  {% if 'probe_eddy_ng btt_eddy' in printer or 'probe_eddy_ng eddy' in printer %}
    PROBE_EDDY_NG_SET_TAP_OFFSET VALUE=0 
    {% if core_vars.offset_reset == True %}
      SET_GCODE_OFFSET Z=0
    {% else %}
      {% if 'probe_eddy_ng btt_eddy' in printer and printer.gcode_move.homing_origin.z != 0.00 %}    
        RESPOND TYPE=COMMAND MSG="Your adjusted offset for this file was: {printer.gcode_move.homing_origin.z|float}mm"
        RESPOND TYPE=COMMAND MSG="Your currently stored Eddy NG tap_adjust_z is: {printer.configfile.settings['probe_eddy_ng btt_eddy'].tap_adjust_z|float}mm"
        RESPOND TYPE=COMMAND MSG="Save_Config to update your Eddy NG tap_adjust_z to: {("%.4fmm" % ((printer.gcode_move.homing_origin.z|float + printer.configfile.settings['probe_eddy_ng btt_eddy'].tap_adjust_z)|float))}mm"

      {% elif 'probe_eddy_ng eddy' in printer and printer.gcode_move.homing_origin.z != 0.00 %}
        RESPOND TYPE=COMMAND MSG="Your adjusted offset for this file was: {printer.gcode_move.homing_origin.z|float}mm"
        RESPOND TYPE=COMMAND MSG="Your currently stored Eddy NG tap_adjust_z is: {printer.configfile.settings['probe_eddy_ng eddy'].tap_adjust_z|float}mm"
        RESPOND TYPE=COMMAND MSG="Save_Config to update your Eddy NG tap_adjust_z to: {("%.4fmm" % ((printer.gcode_move.homing_origin.z|float + printer.configfile.settings['probe_eddy_ng eddy'].tap_adjust_z)|float))}mm"   
      {% endif %}
    {% endif %}
  {% endif %}
  
  {% if start_vars.orca_enable == True and core_vars.offset_reset == False %}
    _ORCA_OFFSET_REMOVE
  {% endif %}

  {% if core_vars.offset_reset == True %}
    SET_GCODE_OFFSET Z=0.0 MOVE=1 # Reset the adjusted G-Code Z offset
  {% endif %}

  {% if start_vars.auto_reset_eddy_offset == True %}
    _EDDY_OFFSET_REMOVE
  {% endif %}



[gcode_macro _OFFSET_FORCE_OVERLAY]
gcode:
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}
  {% set rand_x = range((20|int), (40|int))|random %}
  {% set rand_y = range((175|int), (195|int))|random %}

    G90
    G0 Z10
    G0 X{rand_x|int} Y{rand_y|int} F9000
    RUN_PROBE_VIR_CONTACT
    G0 Z10
    CLEAN_NOZZLE
    G90
    G0 Z10
    G0 X-8 Y286 F5000
    # G0 Z-1 F2400
    G0 Z0.3 F2400
    G0 Y260
    G0 Y286
    M106 S255

  {% if core_vars.filament in ['PLA', 'PLA+', 'PET', 'PETG', 'FLEX', 'TPU'] or core_vars.bed|int < 90 %}
    M118 Low temperature print. Forcing Nozzle temp to 130c for touch systems! Please wait....
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=130
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={130 -2} MAXIMUM={130 + 5}
    M400
    M106 S0
    G1 Z10
    Z_OFFSET_CALIBRATION METHOD=force_overlay EXTRUDER_TEMP=130 BED_TEMP={printer.heater_bed.target}

  {% elif core_vars.filament in ['ASA', 'ABS'] or core_vars.bed|int >= 90 %}
    M118 High temperature print. Forcing Nozzle temp to 150c for touch systems! Please wait....
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=150
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={150 -2} MAXIMUM={150 + 5}
    M400
    M106 S0
    G1 Z10
    Z_OFFSET_CALIBRATION METHOD=force_overlay EXTRUDER_TEMP=150 BED_TEMP={printer.heater_bed.target}
  {% endif %}

    M400
    G1 Z10



[gcode_macro _START_POS]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  
    {% if start_vars.start_x_position >= 50 or start_vars.start_y_position >= 50%}
    {action_emergency_stop("EMERGENCY STOP! EXCESSIVE START POSITION REQUESTED CORRECT IN USER SETTINGS FILE")}

  {% elif start_vars.purge_line_length|float > 150 %}
    {action_emergency_stop("EMERGENCY STOP! EXCESSIVE PURGE LENGTH REQUESTED CORRECT IN USER SETTINGS FILE")}
    
  {% endif %}

    SET_DISPLAY_TEXT MSG="Moving to Start Position"
    RESPOND TYPE=COMMAND MSG="Moving to Start Position"
    G0 Z25 F5000
    G0 X{start_vars.start_x_position} Y{start_vars.start_y_position} F5000 # Move to start position

    
    G0 Z5.0 F5000 # Lower speed
    G0 Z0.5 F150 # Lower slow for wait & to catch oozing nozzle during heating

    

[gcode_macro _PURGE_LINES]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set height = (printer.configfile.settings.extruder.nozzle_diameter * 0.75)|float %} #0.625
  {% set width = (printer.configfile.settings.extruder.nozzle_diameter * 1.25)|float %}
  {% set filament_area = 3.14159 * (printer.configfile.settings.extruder.filament_diameter ** 2) / 4 %}
  {% set rate = start_vars.purge_line_length * ((width * height) / filament_area) %}

  {% if start_vars.purge_lines == False %}
    G0 Z5.0
    SET_DISPLAY_TEXT MSG="Purge lines skipped, Print Start..."
    RESPOND TYPE=COMMAND MSG="Purge lines skipped, Print Start..."

  {% elif start_vars.adaptive_meshing == True and start_vars.purge_lines == True %}
    LINE_PURGE

  {% elif start_vars.use_kamp_adaptive_purge == True and start_vars.purge_lines == True %}
    LINE_PURGE
    
  {% else %}
    SET_DISPLAY_TEXT MSG="Printing Purge Lines"
    RESPOND TYPE=COMMAND MSG="Printing Purge Lines"
    G90  # Absolute mode
    G0 Z1.5 F9000 # Jump up to leave ooze blob

    G91 # Relative mode
  {% if start_vars.purge_along_y == True %}
    G0 Y7 F9000 # Move away from ooze blob
  {% else %}
    G0 X7 F9000
  {% endif %}

    G90 # Absolute mode
    G0 Z{height} F1500    
    G91 # Relative mode
    
  {% if start_vars.purge_along_y == True %} 
    G1 Y{start_vars.purge_line_length} E{rate} F1500 # Draw the first line
    G0 X{width} F5000 # Move to side a little
    G1 Y-{start_vars.purge_line_length -15} E{rate} F1500
    # G4 P2000 # wait 02 seconds    

  {% else %}
    G1 X{start_vars.purge_line_length} E{rate} F1500 # Draw the first line
    G0 Y{width +0.4} F5000 # Move to side a little
    G1 X-{start_vars.purge_line_length -15} E{rate} F1500
    # G4 P2000 # wait 02 seconds 
  {% endif %}

    G0 Z{height} F9000 # Lift a little
    G4 P2000 # wait 02 seconds 
    G0 X5 Y5 F9000 # Wipe Out
    G90 # Absolute mode
    G92 E0.0 # Reset Extruder
    M83 # Extruder relative mode
    G0 Z5.0 F9000 # Move Z Axis up little to prevent scratching of Heat Bed
    M400
    SET_DISPLAY_TEXT MSG="Print Start..."
    RESPOND TYPE=COMMAND MSG="Print Start..."

 {% endif %}
 

  
#######################################################
# Original gcode contribution by NoradZero
# [gcode_macro HANDLE_NEVERMORE_PRINT_END]
# gcode:
#   {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
#   {% set STAY_ON = start_vars.variable_default_nevermore_fan_stay_on | default(True) %}
#   {% set TARGET_SPEED = start_vars.variable_default_nevermore_after_print_speed | default(1) | float %}
#   {% set TARGET_TIME = start_vars.variable_default_nevermore_after_print_time | default(1) | int %}
#   RESPOND TYPE=COMMAND MSG="Handling Nevermore after print filtration"
#   SET_FAN_SPEED FAN=Nevermore SPEED={TARGET_SPEED}
#   {% if STAY_ON == False then }
#     _HEAT_WAIT MSG="After print filtration for..." MINUTES={TARGET_TIME}
#     M400   
#     SET_FAN_SPEED FAN=Nevermore SPEED=0
#     RESPOND TYPE=COMMAND MSG="Shutting down Nevermore filtration"
#   {% endif %}
#######################################################

[gcode_macro _NEVERMORE_POST_PRINT]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}

  {% if start_vars.nevermore_post_timer == False %}
    {% if start_vars.nevermore_leave_running == False %}
      SET_FAN_SPEED FAN=Nevermore SPEED=0
      RESPOND TYPE=COMMAND MSG="Nevermore post print, fan off."
    {% else %}
      RESPOND TYPE=COMMAND MSG="Nevermore post print, leaving fan on."
    {% endif %}
       
  {% else %}
    {% if core_vars.filament in ['PLA', 'PLA+', 'PET', 'PETG', 'FLEX','TPU'] and start_vars.nevermore_asa_abs_only == True %}
      {% if start_vars.nevermore_leave_running == False %}
        SET_FAN_SPEED FAN=Nevermore SPEED=0
        RESPOND TYPE=COMMAND MSG="Nevermore post print timer bypass, fan off."
      {% else %}
        RESPOND TYPE=COMMAND MSG="Nevermore post print timer bypass, leaving fan on."
      {% endif %}
      
    {% else %}
      RESPOND TYPE=COMMAND MSG="Nevermore post print chamber filteration process started, fan set to {("%.0f" % (start_vars.nevermore_post_speed|float * 100))}%"
      SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.nevermore_post_speed|float}
      _HEAT_WAIT MSG="Nevermore post print chamber filtration timer..." MINUTES={start_vars.nevermore_post_run_time|int}
      M400
      {% if start_vars.nevermore_leave_running == False %}
        SET_FAN_SPEED FAN=Nevermore SPEED=0
        RESPOND TYPE=COMMAND MSG="Nevermore post print timer done, fan off."
      {% else %}
        RESPOND TYPE=COMMAND MSG="Nevermore post print timer done, leaving fan on."
      {% endif %}
    {% endif %}
      
  {% endif %}


#######################################################
# If you have a power on/off relay 
# This macro is used to shutdown your printer after printing
# It is called by the END_PRINT macro
#######################################################

[gcode_macro _GOODNIGHT]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}

  {% if printer.extruder.temperature >= 50 %}
    M106 S255 # max part fan to cool
    SET_DISPLAY_TEXT MSG="Cooling hotend for shutdown"
    RESPOND TYPE=COMMAND MSG="Cooling hotend for shutdown"
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM=49
    M400 # wait
  {% endif %}

    M107 # kill fan
    M117 GOODNIGHT...Zzzzzz
    M118 GOODNIGHT...Zzzzzz
    
  {% if start_vars.neopixel_led == True %}
    STATUS_OFF
  {% endif %}    
  
    UPDATE_DELAYED_GCODE ID=_DELAY_OFF DURATION=5
    


[delayed_gcode _DELAY_OFF]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  
  {% if start_vars.shutdown_relay == True %}
    {% if start_vars.all_in_one_pi == True or start_vars.host_shutdown == True %}
      {action_call_remote_method("shutdown_machine")}

    {% elif start_vars.all_in_one_pi == False and start_vars.host_shutdown == False %}
      {action_call_remote_method("set_device_power",device="Printer Power",state="off")}
    {% endif %}
    
  {% else %}
    {action_raise_error("Sorry you have not got a shutdown relay installed. Check the demon_user_settings file hardware options to enable it")}
  {% endif %}

  

[gcode_macro Power_Down]
description: If you have a mains power relay this will power the relay off & shutdown the client
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}

  {% if start_vars.shutdown_relay == True %}
    {action_call_remote_method("set_device_power",device="Printer Power",state="off")}
  {% else %}
   {action_raise_error("Sorry you have not got a shutdown relay installed. Check the demon_user_settings file hardware options to enable it")}
  {% endif %}



#######################################################
  # DEMON CLEAN LOAD ASSETS
#######################################################

[gcode_macro _CONDITIONAL_CLEAN]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  
  {% if start_vars.nozzle_cleaner == True %}
    {% if (printer.configfile.config.stepper_z.endstop_pin != 'probe:z_virtual_endstop') and (printer.configfile.config.stepper_z.endstop_pin != 'probe: z_virtual_endstop') or ('smart_effector' in printer) or
          ('cartographer' in printer) %}
      CLEAN_NOZZLE
    {% endif %}
  {% endif %}

  

[gcode_macro _step_control]
gcode:
  {% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
  {% set rando_x_clean = range((clean_vars.clean_min_x|int), (clean_vars.clean_max_x|int))|random %}
  {% set rando_y_clean = range((clean_vars.clean_min_y|int), (clean_vars.clean_max_y|int))|random %}
  
    G90

  {% if clean_vars.random_clean_x == True and clean_vars.random_clean_y == True %}
    G0 X{rando_x_clean|int} Y{rando_y_clean|int} F{clean_vars.pass_spd * 60|int}

  {% elif clean_vars.random_clean_x == True and clean_vars.random_clean_y == False %}
    G0 X{rando_x_clean|int} Y{clean_vars.linear_clean_start_y|int} F{clean_vars.pass_spd * 60|int}

  {% elif clean_vars.random_clean_x == False and clean_vars.random_clean_y == True %}
    G0 X{clean_vars.linear_clean_start_x|int} Y{rando_y_clean|int} F{clean_vars.pass_spd * 60|int}
  {% endif %}



[gcode_macro _LINEAR_STEP_CONTROL_X]
gcode:
  {% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
  
    G91
  {% if clean_vars.linear_clean_positive_dir == True %}
    G0 X{clean_vars.linear_clean_distance|int} F{clean_vars.pass_spd * 60|int}
  {% else %}
    G0 X-{clean_vars.linear_clean_distance|int} F{clean_vars.pass_spd * 60|int}
  {% endif %}
    G90
    G0 X{clean_vars.linear_clean_start_x|int} F{clean_vars.pass_spd * 60|int}    



[gcode_macro _LINEAR_STEP_CONTROL_Y]
gcode:
  {% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
    
    G91
  {% if clean_vars.linear_clean_positive_dir == True %}
    G0 Y{clean_vars.linear_clean_distance|int} F{clean_vars.pass_spd * 60|int}
  {% else %}
    G0 Y-{clean_vars.linear_clean_distance|int} F{clean_vars.pass_spd * 60|int}
  {% endif %}
    G90
    G0 Y{clean_vars.linear_clean_start_y|int} F{clean_vars.pass_spd * 60|int}    
          


[gcode_macro _random_spot]
gcode:
  {% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
  {% set rando_x = range((clean_vars.purge_min_x|int), (clean_vars.purge_max_x|int))|random %}

    G0 X{rando_x|int} Y{clean_vars.purge_legacy_y_park|float} F9000



#######################################################
# SYSTEM MACROS DO NOT EDIT
#######################################################
#######################################################
# for use with Klicky Probe, in some rare instances the probe can
# be still attached with the steppers engaged & another print can be started
# without the Klicky Macros checking if the probe is still attached.
# this fixes that!
#######################################################

[gcode_macro _klicky_check]
gcode:
    query_probe
    _probe_state action={ params.ACTION }


[gcode_macro _probe_state]
gcode:
  {% set query_probe_triggered = printer.probe.last_query %}
  {% set action  = params.ACTION|default('') %}
  
  {% if query_probe_triggered %}

  {% else %}
    Dock_Probe_Unlock  
  {% endif %}



[gcode_macro _KLICKY_UNLOCKER]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  
  {% if start_vars.klicky_probe == True and (printer.configfile.config.stepper_z.endstop_pin == 'probe:z_virtual_endstop') or (printer.configfile.config.stepper_z.endstop_pin == 'probe: z_virtual_endstop') %}
    RESPOND TYPE=COMMAND MSG="UNLOCKING Klicky Probe!"
    Dock_Probe_Unlock
  {% endif %}
  


[gcode_macro _HOMING_HELPER]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  
    {% if start_vars.klicky_probe == True %}
      {% if (printer.configfile.config.stepper_z.endstop_pin == 'probe:z_virtual_endstop') or (printer.configfile.config.stepper_z.endstop_pin == 'probe: z_virtual_endstop') %}
    #   {% if 'z_virtual_endstop' in printer['configfile'].config["stepper_z"]["endstop_pin"] %}
        _SET_Z_PARK
        {% if "xyz" not in printer.toolhead.homed_axes %}
          {% if start_vars.neopixel_led == True %}
            STATUS_HOMING
          {% endif %}
    
          SET_DISPLAY_TEXT MSG="Homing..."
          RESPOND TYPE=COMMAND MSG="Homing..."
          G28 X Y
          ATTACH_PROBE_LOCK
          RESPOND TYPE=COMMAND MSG="Klicky Probe is now LOCKED!"
          G28 Z
        {% endif %}
        
      {% else %}
        _CONDITIONAL_HOME
      {% endif %}
       
    {% else %}   
      _CONDITIONAL_HOME
    {% endif %}



[gcode_macro _FIRST_CLEAN]
gcode:
  {% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}

  {% if clean_vars.clean_first == True %}
    CLEAN_NOZZLE
    {% if 'probe_eddy_ng btt_eddy' in printer or 'probe_eddy_ng eddy' in printer %}
      _Z_PARK
    {% endif %}
  {% endif %}
  


[gcode_macro _CONDITIONAL_HOME]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  
    _SET_Z_PARK
  {% if "xyz" not in printer.toolhead.homed_axes %}
    {% if start_vars.neopixel_led == True %}
      STATUS_HOMING
    {% endif %}
    
    SET_DISPLAY_TEXT MSG="Homing..."
    RESPOND TYPE=COMMAND MSG="Homing..."
  
    G28
    
  {% else %}
    {% if start_vars.klicky_probe == True %}
      _klicky_check
    {% endif %}
  {% endif %}
    M117
    M400



[gcode_macro M84]
rename_existing: M84.1
gcode:
    _SAVE
    M400
    _Z_READER
    M84.1
    UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=0



[delayed_gcode _ACTIVE_Z_MONITOR]
gcode:
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}

  {% if 'z' in printer.toolhead.homed_axes and printer.print_stats.state not in ["printing", "paused"] %}
    {% if printer.toolhead.position.z != core_vars.last_known_z %}
      _SAVE
      UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=10
    {% else %}
      UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=10
    {% endif %}
    
  {% elif 'z' in printer.toolhead.homed_axes and printer.print_stats.state in ["printing", "paused"] %}
    {% if printer.toolhead.position.z != core_vars.last_known_z %}
      _SAVE
      UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=30
    {% else %}
      UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=30
    {% endif %}
      
  {% else %}
   UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=0
  {% endif %}

  

[gcode_macro _LOAD]
gcode:
  {% set svv = printer.save_variables.variables %}
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=last_known_z VALUE={svv.last_known_z}
    RESPOND TYPE=COMMAND MSG="Z Tracker: Last known Z height was {svv.last_known_z}"

  {% if printer.heater_bed.temperature|int >= 40 and svv.heat_soaked == True %}
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_soaked VALUE=True

  {% elif printer.heater_bed.temperature|int < 40 and svv.heat_soaked == True %}
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_soaked VALUE=False
  {% endif %}

    SET_GCODE_VARIABLE MACRO=_POOP_VARIABLES VARIABLE=loaded_already VALUE={svv.loaded_state}
    # RESPOND TYPE=COMMAND MSG="Saved filament state loaded: {svv.loaded_state}"



[gcode_macro _SAVE]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}
  {% set driver_vars = printer["gcode_macro _DRIVER_VARS"] %}
  {% set svv = printer.save_variables.variables %}

  {% if driver_vars.z_lift_move == True %}
    SAVE_VARIABLE VARIABLE=last_known_z VALUE={("%.2f " % (core_vars.last_known_z + start_vars.pre_home_lift))}
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=last_known_z VALUE={("%.2f " % (core_vars.last_known_z + start_vars.pre_home_lift))}
    SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=z_lift_move VALUE=False
    M400
    
  {% elif core_vars.no_home_z_move == True %}
    SAVE_VARIABLE VARIABLE=last_known_z VALUE={("%.2f " % (core_vars.last_known_z))}
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=no_home_z_move VALUE=False
    M400

  {% elif 'z' not in printer.toolhead.homed_axes %}
    
  {% else %}
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=last_known_z VALUE={("%.2f " % (printer.toolhead.position.z))}
    SAVE_VARIABLE VARIABLE=last_known_z VALUE={("%.2f " % (printer.toolhead.position.z))}
    # M400
  {% endif %}
    
    # RESPOND TYPE=COMMAND MSG="Saving Z height"


  
[gcode_macro _Z_READER]
gcode:
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}
  # {% set driver_vars = printer["gcode_macro _DRIVER_VARS"] %}
  # {% set svv = printer.save_variables.variables %}
    RESPOND TYPE=COMMAND MSG="Z Tracker: Current Z height saved as {core_vars.last_known_z}"
    # RESPOND TYPE=COMMAND MSG="core_var Z height is {core_vars.last_known_z}"
    # RESPOND TYPE=COMMAND MSG="svv Z height is {svv.last_known_z}"
    # RESPOND TYPE=COMMAND MSG="no home move {core_vars.no_home_z_move}"
    # RESPOND TYPE=COMMAND MSG="z lift move {driver_vars.z_lift_move}"



[gcode_macro Z_ASCENDER]
description: Raise the toolhead by the selected distance if the printer is homed or not! 100mm max per activation USE WITH CAUTION!
gcode:
  # {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}
  {% set svv = printer.save_variables.variables %}
  {% set height = params.HEIGHT|default(15)|int %}

    _AUTO_LIGHTS
          
  {% if 'z' not in printer.toolhead.homed_axes %}
    RESPOND TYPE=COMMAND MSG="WARNING AXES RESET FOR Z LIFT!!"
    RESPOND TYPE=COMMAND MSG="EXTREME CAUTION! As the printer is NOT homed already Z0 will be the current toolhead position for the duration of this move! If commanded the Z axis will be able to pass Z maximum resulting in printer damage!!"
    SET_KINEMATIC_POSITION Z=0
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=no_home_z_move VALUE=True
    M400
    G90
    {% if height in range (0, 101) %}
      {% if core_vars.last_known_z <= (printer.toolhead.axis_maximum.z|int - height|int) - 20 %}
        G0 Z{height} F800
        M400
        RESPOND TYPE=COMMAND MSG="Move complete, now disabling axes"
        SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=last_known_z VALUE={("%.2f " % (core_vars.last_known_z + height))}
        M400
        M84

      {% else %}
        {action_raise_error("Request denied, operation cancelled! As the printer is NOT homed estimated toolhead height is too great for requested move!")}
      {% endif %}
      
    {% else %}
      {action_raise_error("Request denied, operation cancelled! Lift height not in range. The maximum single commanded movement range is 0-100mm")}
    {% endif %}
    
  {% else %}
    G90
    {% if height in range (0, 101) %}
      {% if printer.toolhead.position.z <= (printer.toolhead.axis_maximum.z|int - height|int) - 20 %}        
        G0 Z{(printer.toolhead.position.z + height)} F800
        M400
        M400
        _SAVE
        RESPOND TYPE=COMMAND MSG="Move complete!"

      {% else %}
        {action_raise_error("Request denied, operation cancelled! Actual toolhead height is too great for requested move!")}
      {% endif %}
        
    {% else %}
      {action_raise_error("Request denied, operation cancelled! Lift height not in range. The maximum single commanded movement range is 0-100mm")}
    {% endif %}
  {% endif %}



[gcode_macro _Z_PARK]
gcode:
  {% set x_park = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_park = printer.toolhead.axis_maximum.y|float / 2 %}
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}

  {% if start_vars.klicky_probe == True %} 
    {% if (printer.configfile.config.stepper_z.endstop_pin == 'probe:z_virtual_endstop') or (printer.configfile.config.stepper_z.endstop_pin == 'probe: z_virtual_endstop') %}
    Dock_Probe_Unlock
    {% endif %}
  {% endif %}
  {% if start_vars.use_custom_park == False %}
    G0 X{x_park} Y{y_park} Z{core_vars.z_park} F10000

  {% else %}
    {% if start_vars.system_choose_z == True %}
      G0 X{start_vars.custom_park_x} Y{start_vars.custom_park_y} Z{core_vars.z_park} F10000
    {% else %}
      {% if start_vars.custom_park_z|int <= 1|int or start_vars.custom_park_z|int >= (printer.toolhead.axis_maximum.z|int - start_vars.pre_home_lift|int) - 10 %}
        {action_raise_error("Custom Z parking height is to low or too high, change height in the demon user settings file to contiune")}
      {% else %}
        G0 X{start_vars.custom_park_x} Y{start_vars.custom_park_y} Z{start_vars.custom_park_z} F10000
      {% endif %}
    {% endif %}
  {% endif %}
    M400
    _SAVE



[gcode_macro _SET_Z_PARK]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}

  {% if start_vars.system_choose_z == True %}
    {% if 'bltouch' in printer.configfile.config %}
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=z_park VALUE=25

    {% elif 'cartographer' in printer %}
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=z_park VALUE=25

    {% elif 'smart_effctor' in printer %}
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=z_park VALUE=25

    {% elif 'probe_eddy_ng btt_eddy' in printer or 'probe_eddy_ng eddy' in printer %}
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=z_park VALUE=15

    {% elif ('mcu eddy' in printer.configfile.config) or ('probe_eddy_current btt_eddy' in printer) or ('probe_eddy_current eddy' in printer) %}
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=z_park VALUE=25

    {% elif start_vars.klicky_probe == True or (printer.configfile.config.stepper_z.endstop_pin != 'probe:z_virtual_endstop') or (printer.configfile.config.stepper_z.endstop_pin != 'probe: z_virtual_endstop') %}
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=z_park VALUE=50

    {% else %}
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=z_park VALUE=5
    {% endif %}

  {% else %}
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=z_park VALUE={start_vars.custom_park_z}
  {% endif %}



[gcode_macro _ADAPTIVE_MANUAL_LEVELLING]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}

  {% if ('bed_screws' in printer.configfile.config) and ('screws_tilt_adjust' not in printer.configfile.config) %}
    SET_DISPLAY_TEXT MSG="Manual Gantry Levelling: Bed Screws" 
    RESPOND TYPE=COMMAND MSG="Manual Gantry Levelling: Bed Screws" 
    {% if start_vars.neopixel_led == True %}
      STATUS_LEVELING
    {% endif %}
    BED_SCREWS_ADJUST 

  {% elif 'screws_tilt_adjust' in printer.configfile.config %}
    SET_DISPLAY_TEXT MSG="Manual Gantry Levelling: Screws Tilt Calculate" 
    RESPOND TYPE=COMMAND MSG="Manual Gantry Levelling: Screws Tilt Calculate" 
    {% if start_vars.neopixel_led == True %}
      STATUS_LEVELING
    {% endif %}
    SCREWS_TILT_CALCULATE 

  {% else %}
    {action_raise_error("This error is caused by your printer not having bed_screws or screws_tilt_adjust defined! Please define these sections in the printer.cfg file")}
      
  {% endif %}
    M117



[gcode_macro _ADAPTIVE_LEVELLING]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}

  {% if ('bed_screws' in printer.configfile.config or 'screws_tilt_adjust' in printer.configfile.config) and ('quad_gantry_level' not in printer.configfile.config and 'z_tilt' not in printer.configfile.config) %}
    SET_DISPLAY_TEXT MSG="Manual levelling in use, auto levelling bypassed"
    RESPOND TYPE=COMMAND MSG="Manual levelling in use, auto levelling bypassed"

  {% elif ('bed_screws' not in printer.configfile.config and 'screws_tilt_adjust' not in printer.configfile.config) and ('quad_gantry_level' not in printer.configfile.config and 'z_tilt' not in printer.configfile.config) %}
    SET_DISPLAY_TEXT MSG="Manual levelling in use, auto levelling bypassed"
    RESPOND TYPE=COMMAND MSG="Manual levelling in use, auto levelling bypassed"

  {% elif (printer.configfile.settings.printer.kinematics in ['corexy', 'limited_corexy']) and ('z_tilt' in printer.configfile.config) %}
    {% if ('quad_gantry_level' not in printer.configfile.config) %}
      SET_DISPLAY_TEXT MSG="Gantry Levelling CoreXY Z Tilt" 
      RESPOND TYPE=COMMAND MSG="Gantry Levelling CoreXY Z Tilt"  
      {% if start_vars.neopixel_led == True %}
        STATUS_LEVELING
      {% endif %}
      Z_TILT_ADJUST
      M400
    {% endif %}

  {% elif (printer.configfile.settings.printer.kinematics in ['corexy', 'limited_corexy']) and ('quad_gantry_level' in printer.configfile.config) %}
    SET_DISPLAY_TEXT MSG="Gantry Levelling" 
    RESPOND TYPE=COMMAND MSG="Gantry Levelling" 
    {% if start_vars.neopixel_led == True %}
      STATUS_LEVELING
    {% endif %}
    _QGL 
    M400

    {% elif printer.configfile.settings.printer.kinematics in ['cartesian', 'extended_corexy'] and 'z_tilt' in printer.configfile.config %}
  # {% elif printer.configfile.settings.printer.kinematics == 'cartesian' and ('z_tilt' in printer.configfile.config) %}
    SET_DISPLAY_TEXT MSG="Gantry Levelling" 
    RESPOND TYPE=COMMAND MSG="Gantry Levelling"  
    {% if start_vars.neopixel_led == True %}
      STATUS_LEVELING
    {% endif %}
    Z_TILT_ADJUST
    M400
      
  {% elif printer.configfile.settings.printer.kinematics == 'cartesian' and ('z_tilt' not in printer.configfile.config) %}
    RESPOND TYPE=COMMAND MSG="Levelling system not available, skipping Gantry Levelling"

  {% else %}
    {action_raise_error("This error is caused by your printer not supporting this feature!")}
    
  {% endif %}
    M117


[gcode_macro _QGL]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}

    SAVE_GCODE_STATE NAME=STATE_QGL
    BED_MESH_CLEAR 

    _Z_PARK
    
  {% if start_vars.klicky_probe == True %}
    RESPOND TYPE=COMMAND MSG="Klicky Probe present adaptive QGL disabled"
    QUAD_GANTRY_LEVEL
  {% else %}
  
    {% if 'probe_eddy_ng btt_eddy' in printer or 'probe_eddy_ng eddy' in printer %}
      {% if not printer.quad_gantry_level.applied %}
        RESPOND TYPE=COMMAND MSG="EDDY NG: QGL previously not applied, running coarse round!"
        QUAD_GANTRY_LEVEL horizontal_move_z=8 retry_tolerance=1 
      {% endif %}

      {% if printer.configfile.settings.quad_gantry_level.horizontal_move_z|float > 3 %}
        RESPOND TYPE=ERROR MSG="EDDY NG WARNING! Your QGL horizontal_move_z is above recommended height! Please reduce to below 3mm, forcing default 2mm!"
        QUAD_GANTRY_LEVEL horizontal_move_z=2
      {% else %}
        RESPOND TYPE=COMMAND MSG="EDDY NG: QGL running fine rounds!"
        QUAD_GANTRY_LEVEL
      {% endif %}

    {% elif not 'probe_eddy_ng btt_eddy' in printer and not 'probe_eddy_ng eddy' in printer %}
      {% if start_vars.use_adaptive_qgl == True %}
        {% if printer.configfile.settings.quad_gantry_level.horizontal_move_z|float >= 10 %}
          {% if not printer.quad_gantry_level.applied %}
            RESPOND TYPE=COMMAND MSG="Adaptive QGL previously not applied, running coarse round!"
            QUAD_GANTRY_LEVEL retry_tolerance=1
          {% endif %}
        
        {% elif printer.configfile.settings.quad_gantry_level.horizontal_move_z|float < 10 %}
          {% if not printer.quad_gantry_level.applied %}
            RESPOND TYPE=COMMAND MSG="Adaptive QGL previously not applied, coarse round forced 10mm horizontal_move_z!"
            QUAD_GANTRY_LEVEL horizontal_move_z=10 retry_tolerance=1
          {% endif %}
        {% endif %}

        RESPOND TYPE=COMMAND MSG="Adaptive QGL running fine rounds 6mm horizontal_move_z!"
        QUAD_GANTRY_LEVEL horizontal_move_z=6 

      {% else %}
        QUAD_GANTRY_LEVEL
      {% endif %}
    {% endif %}
  {% endif %}

    RESTORE_GCODE_STATE NAME=STATE_QGL



[gcode_macro _DEMON_PAUSE]
variable_offset_reset: False
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}
  {% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
  
  {% if printer.toolhead.position.z|float < 50 %}
    G0 Z50 F3600
  {% endif %}
    
  {% if start_vars.kill_fan_on_pause == True %}
    RESPOND TYPE=COMMAND MSG="Parts fan stopping for pause duration"
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=fan_speed VALUE={("%.2f " % (printer["fan"].speed|float))}
    M107
  {% endif %}

  {% if ceal.ceal_master_enable == True %}
    {% if ceal.pause == True %}
      _CUSTOM_PAUSE {rawparams}
    {% endif %}
  {% endif %}

  _SAVE

  M400
  {% if core_vars.fil_change_pause == False %}
    {% if start_vars.auto_cool_on_pause %}
      SET_DISPLAY_TEXT MSG="Setting pause nozzle temp..."
      RESPOND TYPE=COMMAND MSG="Setting reduced nozzle temperature for pause duration"
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={(printer.configfile.settings.extruder.min_extrude_temp + 5)}
    {% endif %}
  {% endif %}
  


[gcode_macro _DEMON_CANCEL]
variable_offset_reset: False
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}
  {% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}

    RESPOND TYPE=COMMAND MSG="Print Cancelled!"
  {% if printer.print_stats.state != paused and printer.toolhead.position.z|float < 50 %}
    G0 Z50 F3600
  {% endif %}

    _OFFSET_RESET_CONTROL

    BED_MESH_CLEAR
    M220 S100 # reset feed rate to 100 percent
    M221 S100 # reset flow rate to 100 percent
    SET_VELOCITY_LIMIT ACCEL={printer.configfile.config.printer.max_accel}
    SET_VELOCITY_LIMIT VELOCITY={printer.configfile.config.printer.max_velocity}
    
  {% if start_vars.encoder_runout_sensor == True %}
    SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0
  {% endif %}

  {% if ceal.ceal_master_enable == True %}
    {% if ceal.cancel == True %}
      _CUSTOM_CANCEL {rawparams}
    {% endif %}
  {% endif %}
  
    _SAVE
  {% if start_vars.z_tracker_reduced_monitoring == False %}
    UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=1
  {% endif %}

  {% if start_vars.sovol_plr == True %}
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
    RUN_SHELL_COMMAND CMD=clear_plr
    clear_last_file
  {% endif %}

    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=fil_change_pause VALUE=False
  


[gcode_macro _DEMON_RESUME]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}
  {% set resume = printer["gcode_macro RESUME"] %}
  {% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}

  {% if core_vars.fil_change_pause == False %}
    {% if start_vars.auto_cool_on_pause %}
      {% if printer.extruder.target|int != resume.last_extruder_temp.temp|int %}
        SET_DISPLAY_TEXT MSG="Restoring nozzle temp..."
        RESPOND TYPE=COMMAND MSG="Restoring printing nozzle temperature to {resume.last_extruder_temp.temp|int}c, please wait..."
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={resume.last_extruder_temp.temp|int} 
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={resume.last_extruder_temp.temp|int -2} MAXIMUM={resume.last_extruder_temp.temp|int + 5}
      {% endif %}
    {% endif %}
  {% endif %}
      
  {% if start_vars.chamber_heater and core_vars.filament not in ["ASA", "ABS"] %}
    UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=1
    RESPOND TYPE=COMMAND MSG="Chamber Heater Monitor Active"
  {% endif %}

  {% if start_vars.bed_fans == True %}
    UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=1
    RESPOND TYPE=COMMAND MSG="Bed Fans Monitor Active"
  {% endif %}

  {% if start_vars.nevermore == True and resume.idle_state == True %}
    {% if core_vars.nm_fan_speed != 0 %}
      SET_FAN_SPEED FAN=Nevermore SPEED={core_vars.nm_fan_speed|float}
      RESPOND TYPE=COMMAND MSG="Restoring Nevermore fan speed"
      M400
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=nm_fan_speed VALUE=0
    {% endif %}
  {% endif %}

    SET_DISPLAY_TEXT MSG="Resuming print!"
    RESPOND TYPE=COMMAND MSG="Resuming print!"
    
  {% if start_vars.kill_fan_on_pause == True %}
    M106 S{("%.0f " % (core_vars.fan_speed|float * 255))} 
    RESPOND TYPE=COMMAND MSG="Restoring parts fan speed"
  {% endif %}

  {% if ceal.ceal_master_enable == True %}
    {% if ceal.resume == True %}
      _CUSTOM_RESUME {rawparams}
    {% endif %}
  {% endif %}

    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=fil_change_pause VALUE=False
  

  
[gcode_macro _DEMON_IDLE_TIMEOUT]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  
  {% if start_vars.nevermore == True and printer["fan_generic Nevermore"].speed|float != 0.0 %}
    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=nm_fan_speed VALUE={printer["fan_generic Nevermore"].speed|float}
    SET_FAN_SPEED FAN=Nevermore SPEED=0.0
  {% endif %}
  
  {% if printer.print_stats.state == "paused" %}
    {% if start_vars.infinite_pause == True %}
      SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=idle_state VALUE=True
      M107
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
      SET_DISPLAY_TEXT MSG="Idle timeout: Infinite pause running, nozzle powered down, auto re-heat enabled. Waiting for user..."
      RESPOND TYPE=COMMAND MSG="Idle timeout: Infinite pause running, nozzle powered down, auto re-heat enabled. Waiting for user..."
      _SAVE

    {% else %}
      SET_DISPLAY_TEXT MSG="PRINT CANCELLED! Pause timed out! Please enable variable_infinite_pause in demon_user_settings.cfg to avoid this & restart your print"
      RESPOND TYPE=COMMAND MSG="PRINT CANCELLED! Pause timed out! Please enable variable_infinite_pause in demon_user_settings.cfg to avoid this & restart your print"
      SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=nm_fan_speed VALUE=0
      CANCEL_PRINT
      M84
      {% if start_vars.timeout_power == True and start_vars.shutdown_relay == True %}
        _GOODNIGHT
      {% endif %}
    {% endif %}
    
  {% else %}
    SET_DISPLAY_TEXT MSG="Idle Timeout"
    RESPOND TYPE=COMMAND MSG="Idle Timeout"
    TURN_OFF_HEATERS
    M84
    {% if start_vars.timeout_power == True and start_vars.shutdown_relay == True %}
      _GOODNIGHT
    {% endif %}
    
  {% endif %}



[gcode_macro FILAMENT_CHANGE]
gcode:

    _FIL_CHANGE_PARK



[gcode_macro M600]
gcode:

    _FIL_CHANGE_PARK

  

[gcode_macro _FIL_CHANGE_PARK]
gcode: 
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}

  {% if ceal.ceal_master_enable == True %}
    {% if ceal.pre_fil_change_park == True %}
      _CUSTOM_PRE_FIL_CHANGE_PARK {rawparams}
    {% endif %}
  {% endif %}

    SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=fil_change_pause VALUE=True

    SET_DISPLAY_TEXT MSG="Moving to filament change position, use load/unload macros when ready!"
    RESPOND TYPE=COMMAND MSG="Moving to filament change position, use load/unload macros when ready!"
    PAUSE X={start_vars.filament_change_park_x} Y={start_vars.filament_change_park_y} Z_MIN={start_vars.filament_change_park_min_z} RESTORE=0
    _SAVE

  {% if ceal.ceal_master_enable == True %}
    {% if ceal.post_fil_change_park == True %}
      _CUSTOM_POST_FIL_CHANGE_PARK {rawparams}
    {% endif %}
  {% endif %}


[gcode_macro _MAX_EXTRUDE_CHECK]
gcode:
  {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity * 60 %}
  
  {% if max_velocity == 7982.432411074328 %}
    {action_raise_error("Please set a feedrate mm per second max_extrude_only_velocity in your printer.cfg [extruder] section. e.g. max_extrude_only_velocity: 18")}

  {% elif max_velocity <= 900 %}
    RESPOND TYPE=error MSG="I noticed your max_extrude_only_velocity in your printer.cfg [extruder] section is a little low for current recommended settings. Please increase to around 20-25 if possible! Orbiter v2.x tend to like around 15-18"
  {% endif %}
  
  {% if max_velocity > 1500 %} #1260 %}
    {action_raise_error("WARNING! Your printer's max_extrude_only_velocity setting is too high! The operation has been cancelled to prevent damage to your extruder! Reset to a feedrate value below 25mm/s in your printer.cfg [extruder] section. A higher value is better.")}
  {% endif %}



[gcode_macro _RUNOUT_SENSOR_CHECK]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}

  {% if start_vars.runout_sensor == True %}
    {% if printer['filament_switch_sensor filament_sensor'].enabled == 1 %}
      {% if not printer["filament_switch_sensor filament_sensor"].filament_detected %} # Runout Sensor Check, E-Stop if empty! 
        {action_raise_error("This error is caused by no filament being loaded! Please load filament & retry!")}
      {% else %}
        RESPOND TYPE=COMMAND MSG="Runout sensor: Enabled, filament check passed"
      {% endif %}
    
    {% elif printer['filament_switch_sensor filament_sensor'].enabled != 1 %}
      RESPOND TYPE=COMMAND MSG="Runout sensor: Disabled, filament check skipped"
    {% endif %} 
  {% endif %}



[gcode_macro _ENCODER_FEED_CHECK_PREP]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  
    {% if start_vars.encoder_runout_sensor == True %}
      {% if printer['filament_motion_sensor encoder_sensor'].enabled != 1 %}
        SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=1
      {% endif %} 
    {% endif %}


[gcode_macro _ENCODER_FEED_CHECK]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  
    {% if start_vars.encoder_runout_sensor == True %}
      {% if not printer["filament_motion_sensor encoder_sensor"].filament_detected %} # Runout Sensor Check, stop if empty! 
        {% if printer.print_stats.state == "paused" %}
          RESPOND TYPE=error MSG="Encoder filament sensor triggered! This error is caused by the filament not being taken up by the extruder, or the nozzle is clogged! Please check filament state & try again!"
        {% else %}
          {action_raise_error("Encoder filament sensor triggered! This error is caused by the filament not being taken up by the extruder, or the nozzle is clogged! Please check filament state & try again!")}
        {% endif %}
      {% endif %}
      
      UPDATE_DELAYED_GCODE ID=_ENCODER_RUNOUT_CONTROL DURATION=5
    {% endif %}
     
  

[delayed_gcode _ENCODER_RUNOUT_CONTROL]
gcode:

  {% if printer.print_stats.state not in ['printing', 'paused'] %}
    SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0
    UPDATE_DELAYED_GCODE ID=_ENCODER_RUNOUT_CONTROL DURATION=0

  {% elif printer.print_stats.state in ['printing', 'paused'] %}
    {% if printer.print_stats.info.current_layer in range(0, 2) %}
      SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0
      UPDATE_DELAYED_GCODE ID=_ENCODER_RUNOUT_CONTROL DURATION=10 
    {% else %}
      SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=1
      UPDATE_DELAYED_GCODE ID=_ENCODER_RUNOUT_CONTROL DURATION=0
      RESPOND TYPE=COMMAND MSG="Layer 1 complete, encoder runout sensor enabled"
    {% endif %}
  {% endif %}


# Adapted macro. Original macro available here https://moonraker.readthedocs.io/en/latest/configuration/?h=klipper+power+device#gcode-macro-restrictions
[gcode_macro SET_AUTO_LIGHTS]
variable_value: 1
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  
  {% if 'VALUE' not in params %}
    {action_raise_error("Parameter 'VALUE' missing from 'SET_AUTO_LIGHTS'")}
  {% endif %}
  {% set state = params.VALUE|int %}

  {% if not start_vars.printer_lights and not start_vars.neopixel_led and not heater_neo %}
    RESPOND TYPE=error MSG="No lights are enabled in your demon_user_settings cfg file!"
  {% endif %}
  
  {% if state %}
    RESPOND TYPE=COMMAND MSG="Setting AUTO_LIGHTS: ON"
    {% if start_vars.printer_lights %}
      SET_LED LED=Printer_Lights WHITE=1.00 SYNC=0 TRANSMIT=1
    {% endif %}
    
    {% if start_vars.neopixel_led %}
        STATUS_READY
      {% endif %}

    {% if start_vars.chamber_heater and start_vars.heater_neo %}
      SET_LED LED="Chamber_Heater_Neopixel" RED=1.0 GREEN=0.0 BLUE=1.0 WHITE=0 SYNC=0 TRANSMIT=1
    {% endif %}

  {% else %}
    RESPOND TYPE=COMMAND MSG="Setting AUTO_LIGHTS: OFF"
    {% if start_vars.printer_lights %}
      SET_LED LED=Printer_Lights WHITE=0.00 SYNC=0 TRANSMIT=1
    {% endif %}
    
    {% if start_vars.neopixel_led %}
      STATUS_OFF
    {% endif %}

    {% if start_vars.chamber_heater and start_vars.heater_neo %}
      SET_LED LED="Chamber_Heater_Neopixel" RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0 SYNC=0 TRANSMIT=1
    {% endif %}
  {% endif %}

    SET_GCODE_VARIABLE MACRO=SET_AUTO_LIGHTS VARIABLE=value value={state}
# Adapted macro. Original macro available here https://moonraker.readthedocs.io/en/latest/configuration/?h=klipper+power+device#gcode-macro-restrictions



[gcode_macro _AUTO_LIGHTS]
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set lights = printer["gcode_macro SET_AUTO_LIGHTS"] %}

  {% if start_vars.printer_lights or start_vars.neopixel_led or heater_neo %}
    {% if not lights.value %}
      SET_AUTO_LIGHTS VALUE=1
    {% endif %}
  {% endif %}
  


[gcode_macro _RESET_FILE_STATE]
gcode:

  {% if printer.print_stats.state not in ["printing", "paused", "busy"] %}
    SDCARD_RESET_FILE
    SET_DISPLAY_TEXT MSG="Printer State reset to Standby"
    G4 P5000
    M117
  {% else %}
    SET_DISPLAY_TEXT MSG="File reset denied, printer is busy"
    RESPOND TYPE=error MSG="File reset denied, printer is busy"
  {% endif %}


[gcode_macro PRINTER_STATUS]
description: Checks the current status of your system!
gcode:
  {% if "xyz" != printer.toolhead.homed_axes%}
    RESPOND TYPE=COMMAND MSG="Homed Axes: None"
  {% else %}
    RESPOND TYPE=COMMAND MSG="Homed Axes: {printer.toolhead.homed_axes}"
  {% endif %}
    
  {% if printer.print_stats.state == "standby" and printer.idle_timeout.state == "Printing" %}
   RESPOND TYPE=COMMAND MSG="Printer timeout state: Busy"
  {% else %}
    RESPOND TYPE=COMMAND MSG="Printer timeout state: {printer.idle_timeout.state}"
  {% endif %}
    
    RESPOND TYPE=COMMAND MSG="Printer status: {printer.print_stats.state}"
    RESPOND TYPE=COMMAND MSG="Virtual SDcard is active: {printer.virtual_sdcard.is_active}"
  
  {% if printer.print_stats.state in ["printing", "paused"] %}
    RESPOND TYPE=COMMAND MSG="Virtual SDcard print progess in percent: {printer.virtual_sdcard.progress}"
    RESPOND TYPE=COMMAND MSG="File: {printer.print_stats.filename}"
    RESPOND TYPE=COMMAND MSG="Info: {printer.print_stats.info}"
    RESPOND TYPE=COMMAND MSG="{printer.print_stats.message}"
  {% endif %}

  
  
[gcode_macro SYSTEM_SENSORS]
description: Shows you the system names of available sensors on your printer
gcode:
  { action_respond_info(printer.heaters.available_heaters | join(' | ')) }
  { action_respond_info(printer.heaters.available_sensors | join(' | ')) }   



[delayed_gcode _welcome]
initial_duration: 2
gcode:
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set svv = printer.save_variables.variables %}
  
  {% if svv.using_shell == True %}
    _DISK_SPACE_CHECK
  {% else %}
    RESPOND TYPE=command MSG="Shell script extension not in use. Disk_Space_Check disbaled."
  {% endif %}

    _DEMON_VERSION
    M400
    _LOAD
    
  {% if printer.print_stats.state not in ['printing', 'paused'] %}
    SET_DISPLAY_TEXT MSG="{start_vars.screen_msg}"
    RESPOND TYPE=COMMAND MSG="{start_vars.console_msg}"
  {% endif %}

  {% if start_vars.sovol_plr == True %}
    {% if svv.was_interrupted == True %}
      _INTERRUPTED_PROMPT
    {% endif %}
  {% endif %}



[delayed_gcode _DEMON_START_WATCHER]
gcode:
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}

  {% if printer.print_stats.state in ['printing', 'paused'] %}
    {% if core_vars.stage_one_end == False and core_vars.gcode_started == True %}
      {action_raise_error("There was an issue with the start process, please check your setup for any errors or mistakes. If none are found try disabling the BED_CHECKER heat soak system in the demon_user_settings file!")}

    {% elif core_vars.stage_one_end == False and core_vars.gcode_started == False %}
      UPDATE_DELAYED_GCODE ID=_DEMON_START_WATCHER DURATION=1
      
    {% elif core_vars.stage_one_end == True and core_vars.gcode_started == True %}
      UPDATE_DELAYED_GCODE ID=_DEMON_START_WATCHER DURATION=0
    {% endif %}

  {% else %}
    UPDATE_DELAYED_GCODE ID=_DEMON_START_WATCHER DURATION=0
  {% endif %}


  
[gcode_macro _SPS]
gcode:
  {% set gcode_start = params.GSTART|default(True) %}

  SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=gcode_started VALUE={gcode_start}
     


[delayed_gcode _USER_FILES_CHECK]
initial_duration: 10
gcode:

  {% if not printer["gcode_macro _START_VARIABLES"] %}
    RESPOND TYPE=error MSG="WARNING: The demon_user_settings cfg file is NOT included in the system! Please include this file & set it up BEFORE you try to print!"
    SET_DISPLAY_TEXT MSG="WARNING: The demon_user_settings cfg file is NOT included in the system! Please include this file & set it up BEFORE you try to print!"

  {% elif not printer["gcode_macro _CLEAN_VARIABLES"] %}
    RESPOND TYPE=error MSG="WARNING: The demon_user_settings_cleaner_variables cfg file is NOT included in the system! Please include this file & set it up BEFORE you try to print!"
    SET_DISPLAY_TEXT MSG="WARNING: The demon_user_settings_cleaner_variables cfg file is NOT included in the system! Please include this file & set it up BEFORE you try to print!"

  {% elif not printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
    RESPOND TYPE=error MSG="WARNING: The demon_custom_expansion cfg file is NOT included in the system! Please include this file & set it up BEFORE you try to print!"
    SET_DISPLAY_TEXT MSG="WARNING: The demon_custom_expansion cfg file is NOT included in the system! Please include this file & set it up BEFORE you try to print!"
  {% endif %}

  {% if 'force_move' not in printer.configfile.config %}
    RESPOND TYPE=error MSG="WARNING: The force_move printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
    SET_DISPLAY_TEXT MSG="WARNING: The force_move printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
  {% endif %}

  {% if 'respond' not in printer.configfile.config %}
    RESPOND TYPE=error MSG="WARNING: The respond printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
    SET_DISPLAY_TEXT MSG="WARNING: The respond printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
  {% endif %}

  {% if 'save_variables' not in printer.configfile.config %}
    RESPOND TYPE=error MSG="WARNING: The save_variables printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
    SET_DISPLAY_TEXT MSG="WARNING: The save_variables printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
  {% endif %}

  {% if 'exclude_object' not in printer.configfile.config %}
    RESPOND TYPE=error MSG="WARNING: The exclude_object printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
    SET_DISPLAY_TEXT MSG="WARNING: The exclude_object printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
  {% endif %}

  {% if ('output_pin Printer_Lights' in printer.configfile.config) %}
    RESPOND TYPE=error MSG="WARNING: Printer Lights section has been updated to a LED config please modify your printer.cfg. See Demon macros Github documentation regarding Printer_Lights setup!"
    SET_DISPLAY_TEXT MSG="WARNING: Printer Lights section has been updated to a LED config please modify your printer.cfg. See Demon macros Github documentation regarding Printer_Lights setup!"
  {% endif %}



[gcode_macro _DEMON_VERSION_MISMATCH]
gcode:
    {action_raise_error("This error is caused by a Demon_version mismatch as stated on the line below. Please check and update your Demon Essentials Macro files!")}



[gcode_macro _DEMON_VARS_UPDATER]
gcode:

    # SAVE_VARIABLE VARIABLE=first_boot VALUE=True
    # SAVE_VARIABLE VARIABLE=first_boot_msg VALUE=False
    # SAVE_VARIABLE VARIABLE=last_known_z VALUE=0
    SAVE_VARIABLE VARIABLE=heat_soaked VALUE=False
    SAVE_VARIABLE VARIABLE=loaded_state VALUE=False
    # SAVE_VARIABLE VARIABLE=updated_cleaner VALUE=False
    # SAVE_VARIABLE VARIABLE=updated_expansion VALUE=False
    # SAVE_VARIABLE VARIABLE=updated_settings VALUE=False
    # SAVE_VARIABLE VARIABLE=using_shell VALUE=False
    SAVE_VARIABLE VARIABLE=version_dvars VALUE='"1.0.3"'
    SAVE_VARIABLE VARIABLE=version_dvars_updated VALUE=True
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
    
    M400
    RESPOND TYPE=COMMAND MSG="demon_vars.cfg file updated to new version! AUTO RESTARTING NOW!"
    RESTART



[gcode_macro _SLICER_GCODE_CHECK]
gcode:
  {% set core_vars = printer["gcode_macro _CORE_VARS"] %}
  {% set sgc = "v1.3"|string %}
  {% set prev_sgc = "v1.2"|string %}

  {% if core_vars.slicer_gcode > sgc|string %}
   {action_raise_error("This error is caused by your sliced file having a **NEWER** Slicer Machine Start Gcode version than expected! Please update your DKEU macros via update manager, or revert back to an older Machine Start Gcode!!")}

  {% elif core_vars.slicer_gcode == ""|string %}
    {action_raise_error("This error is caused by your sliced file not having the correct DEMON Machine Start Gcode! Please update your slicer's machine Gcode! Visit the Demon Github for more information!")}

  {% elif core_vars.slicer_gcode == prev_sgc|string %}
    RESPOND TYPE=error MSG="NOTICE: You are using an **OLDER** Slicer Machine Start Gcode version, it will become outdated after the next upadte. Please update your slicer's machine Gcode! Visit the Demon Github for more information!"

  {% elif core_vars.slicer_gcode < prev_sgc|string %}
   {action_raise_error("This error is caused by your sliced file not having the most up to date DEMON Machine Start Gcode! Please update your slicer's machine Gcode! Visit the Demon Github for more information!")}

  {% elif core_vars.slicer_gcode == sgc|string %}
    RESPOND TYPE=COMMAND MSG="SGC: PASSED"
    
  {% else %}
    {action_raise_error("This error is caused by something weird going on with your DEMON Machine Start Gcode, please check it is entered correctly & try again!")}
  {% endif %}



[gcode_macro _DEMON_VERSION]
variable_demon_user_settings_version: "2.10.1"
variable_demon_clnvars_version: "1.1.2"
variable_demon_ceal_version: "1.0.4"
variable_demon_demon_vars_version: "1.0.3"
variable_demon_clean_load_version: "1.10.2"
variable_demon_setup_hlpr_version: "1.5.7"
variable_demon_z_cal_version: "1.6.7"
variable_demon_prpr_menu: "1.2.4"
variable_demon_mesh_bldr_version: "1.5.4"
variable_demon_apa_version: "1.2.0"
variable_demon_bed_fans_version: "1.3.0"
variable_demon_core_version: "1.5.15"
variable_demon_prnt_strt_version: "2.10.2"
variable_demon_chmbr_htr_version: "1.1.2"
variable_demon_aes_version: "1.1.0"
variable_demon_home_ctrl_version: "1.4.5"
variable_demon_bed_checker_hs_version: "1.0.11"
variable_demon_buf_stp_version: "1.0.3"
variable_demon_plr_version: "1.0.1"

gcode:
  {% set dvv = printer["gcode_macro _DEMON_VERSION_VARS"] %}
  {% set svv = printer.save_variables.variables %}
  {% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
  {% set clean_load_ver = printer["gcode_macro _CLEAN_LOAD_VERSION"] %}
  {% set setup_helpers_ver = printer["gcode_macro _SETUP_HELPERS_VERSION"] %}
  {% set z_cal_ver = printer["gcode_macro _Z_CALIBRATION_VERSION"] %}
  {% set prepare_menu_ver = printer["gcode_macro _PREPARE_MENU_VERSION"] %}
  {% set mesh_builder_ver = printer["gcode_macro _MESH_BUILDER_VERSION"] %}
  {% set pa_vars = printer["gcode_macro _PA_VERSION"] %}
  {% set bed_fans_ver = printer["gcode_macro _BED_FANS_VERSION"] %}
  {% set core_ver = printer["gcode_macro _CORE_VERSION"] %}
  {% set print_start_ver = printer["gcode_macro _PRINT_START_VERSION"] %}
  {% set chamber_heater_ver = printer["gcode_macro _CHAMBER_HEATER_VERSION"] %}
  {% set aes_ver = printer["gcode_macro _AES_VERSION"] %}
  {% set home_ver = printer["gcode_macro _HOME_VERSION"] %}
  {% set clean_vars_ver = printer["gcode_macro _CLEAN_VARS_VER"] %}
  {% set ceal_ver = printer["gcode_macro _CEAL_VERSION"] %}
  {% set bed_chkr_hs_ver = printer["gcode_macro _BED_CHECKER_VERSION"] %}
  {% set buf_stp_ver = printer["gcode_macro _DEMON_BUFFER_STEPPER_VERSION"] %}
  {% set plr_ver = printer["gcode_macro _DEMON_PLR_VERSION"] %}

  {% if svv.version_dvars|string != demon_demon_vars_version|string %}
    _DEMON_VARS_UPDATER

  {% else %}
  
    {% if svv.version_dvars_updated == True and svv.using_shell == True %}
      SAVE_VARIABLE VARIABLE=version_dvars_updated VALUE=False
      RESPOND TYPE=COMMAND MSG="WARNING: Demon_Vars FILE HAS BEEN UPDATED! Default settings are in effect!"
      _UPDATE_DEMON_VARS_CONFIRM
    {% endif %}

    {% if start_vars.demon_version|string != demon_user_settings_version|string %}
      {% if svv.using_shell == True %}
        {% if printer.print_stats.state not in ['printing', 'paused', 'busy'] %}
          _USER_SETTINGS_FILE_PROMPT
        {% else %}
          RESPOND TYPE=error MSG="DEMON_USER_SETTINGS VERSION MISMATCH"
          _DEMON_VERSION_MISMATCH
        {% endif %}  
      {% else %}
        RESPOND TYPE=error MSG="DEMON_USER_SETTINGS VERSION MISMATCH"
        _DEMON_VERSION_MISMATCH
      {% endif %}

    {% elif clean_vars_ver.demon_clean_vars_ver|string != demon_clnvars_version|string %}
      {% if svv.using_shell == True %}
        {% if printer.print_stats.state not in ['printing', 'paused', 'busy'] %}
          _USER_CLEANER_FILE_PROMPT
        {% else %}
          RESPOND TYPE=error MSG="DEMON_USER_SETTINGS_CLEANER_VARIABLES VERSION MISMATCH"
          _DEMON_VERSION_MISMATCH
        {% endif %}
      {% else %}
        RESPOND TYPE=error MSG="DEMON_USER_SETTINGS_CLEANER_VARIABLES VERSION MISMATCH"
        _DEMON_VERSION_MISMATCH
      {% endif %}

    {% elif ceal_ver.demon_ceal|string != demon_ceal_version|string %}
      {% if svv.using_shell == True %}
        {% if printer.print_stats.state not in ['printing', 'paused', 'busy'] %}
          _USER_EXPANSION_FILE_PROMPT
        {% else %}
          RESPOND TYPE=error MSG="DEMON_USER_SETTINGS_CEAL VERSION MISMATCH"
          _DEMON_VERSION_MISMATCH
        {% endif %}   
      {% else %}
        RESPOND TYPE=error MSG="DEMON_USER_SETTINGS_CEAL VERSION MISMATCH"
        _DEMON_VERSION_MISMATCH
      {% endif %}
    {% elif clean_load_ver.demon_clean_load|string != demon_clean_load_version|string %}
      RESPOND TYPE=error MSG="DEMON_CLEAN_LOAD VERSION MISMATCH"
      _DEMON_VERSION_MISMATCH 

    {% elif setup_helpers_ver.demon_setup|string != demon_setup_hlpr_version|string %}
      RESPOND TYPE=error MSG="DEMON_SETUP_HELPERS VERSION MISMATCH"
      _DEMON_VERSION_MISMATCH

    {% elif z_cal_ver.demon_z_cal|string != demon_z_cal_version|string %}
      RESPOND TYPE=error MSG="DEMON_ZCAL VERSION MISMATCH"
      _DEMON_VERSION_MISMATCH   

    {% elif prepare_menu_ver.demon_prepare_menu|string != demon_prpr_menu|string %}
      RESPOND TYPE=error MSG="DEMON_PREPARE_MENU VERSION MISMATCH"
      _DEMON_VERSION_MISMATCH

    {% elif mesh_builder_ver.demon_mesh_builder|string != demon_mesh_bldr_version|string %}
      RESPOND TYPE=error MSG="DEMON_MESH_BUILDER VERSION MISMATCH"
      _DEMON_VERSION_MISMATCH 

    {% elif pa_vars.demon_apa|string != demon_apa_version|string %}
      RESPOND TYPE=error MSG="DEMON_PA VERSION MISMATCH"
      _DEMON_VERSION_MISMATCH 

    {% elif bed_fans_ver.demon_bed_fans|string != demon_bed_fans_version|string %}
      RESPOND TYPE=error MSG="DEMON_BED_FANS VERSION MISMATCH"
      _DEMON_VERSION_MISMATCH 

    {% elif core_ver.demon_core_ver|string != demon_core_version|string %}
      RESPOND TYPE=error MSG="DEMON_CORE VERSION MISMATCH"
      _DEMON_VERSION_MISMATCH

    {% elif print_start_ver.demon_start_ver|string != demon_prnt_strt_version|string %}
      RESPOND TYPE=error MSG="DEMON_PRINT_START VERSION MISMATCH"
      _DEMON_VERSION_MISMATCH

    {% elif chamber_heater_ver.demon_chamber_heater_ver|string != demon_chmbr_htr_version|string %}
      RESPOND TYPE=error MSG="DEMON_CHAMBER_HEATER VERSION MISMATCH"
      _DEMON_VERSION_MISMATCH

    {% elif aes_ver.demon_aes_ver|string != demon_aes_version|string %}
      RESPOND TYPE=error MSG="DEMON_AES VERSION MISMATCH"
      _DEMON_VERSION_MISMATCH

    {% elif home_ver.demon_home_ver|string != demon_home_ctrl_version|string %}
      RESPOND TYPE=error MSG="DEMON_HOME VERSION MISMATCH"
      _DEMON_VERSION_MISMATCH

    {% elif bed_chkr_hs_ver.demon_bed_checker|string != demon_bed_checker_hs_version|string %}
      RESPOND TYPE=error MSG="DEMON BED_CHECKER_HEAT_SOAK VERSION MISMATCH"
      _DEMON_VERSION_MISMATCH

    {% elif 'buffer_stepper filament_buffer' in printer.configfile.config and not printer["gcode_macro _DEMON_BUFFER_STEPPER_VERSION"] %}
      # {% if not printer["gcode_macro _DEMON_BUFFER_STEPPER_VERSION"] %}
        _BUFFER_STEPPER_CFG_CHECKER

    {% elif ('buffer_stepper filament_buffer' in printer.configfile.config) and (buf_stp_ver.demon_buf_stp_ver|string != demon_buf_stp_version|string) %}
       _BUFFER_STEPPER_CFG_CHECKER
       
    {% elif start_vars.sovol_plr == True and not printer["gcode_macro _DEMON_PLR_VERSION"] %}
       _DEMON_PLR_CFG_CHECKER
    
    {% elif printer["gcode_macro _DEMON_PLR_VERSION"] and plr_ver.demon_plr_ver|string != demon_plr_version|string %}
       _DEMON_PLR_CFG_CHECKER

    {% else %}
      RESPOND TYPE=COMMAND MSG="PRINTER CHECK: PASSED"
    {% endif %}

    {% if svv.using_shell == True %}
      _UPDATED
    {% endif %} 
  {% endif %}


  
[gcode_macro _BUFFER_STEPPER_CFG_CHECKER]
gcode:
  {% set svv = printer.save_variables.variables %}

  {% if svv.using_shell == True %}
    {% if printer.print_stats.state not in ['printing', 'paused', 'busy'] %}
      _BUFFER_STEPPER_PROMPT
    {% else %}
      RESPOND TYPE=error MSG="BUFFER_STEPPER.cfg_VERSION_MISMATCH"
      _DEMON_VERSION_MISMATCH
    {% endif %}
  {% else %}
    RESPOND TYPE=error MSG="BUFFER_STEPPER.cfg_VERSION_MISMATCH"
    _DEMON_VERSION_MISMATCH
  {% endif %}



[gcode_macro _DEMON_PLR_CFG_CHECKER]
gcode:
  {% set svv = printer.save_variables.variables %}

  {% if svv.using_shell == True %}
    {% if printer.print_stats.state not in ['printing', 'paused', 'busy'] %}
      _DEMON_PLR_PROMPT
    {% else %}
      RESPOND TYPE=error MSG="PLR.cfg_VERSION_MISMATCH"
      _DEMON_VERSION_MISMATCH
    {% endif %}
  {% else %}
    RESPOND TYPE=error MSG="PLR.cfg_VERSION_MISMATCH"
    _DEMON_VERSION_MISMATCH
  {% endif %}



[gcode_macro _DEMON_REBOOTER]
gcode:

  {action_call_remote_method("reboot_machine")}
  


[gcode_macro _CORE_VERSION]
variable_demon_core_ver: "1.5.15"
gcode:


    
    
